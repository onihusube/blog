# ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´08æœˆï¼‰

æ–‡æ›¸ã®ä¸€è¦§

- [JTC1/SC22/WG21 - Papers 2022 mailing2022-08](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/#mailing2022-08)

å…¨éƒ¨ã§27æœ¬ã‚ã‚Šã¾ã™ã€‚

[:contents]

### [N4914 WG21 2022-07 Admin telecon minutes](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/n4914.pdf)

WG21ã®å„ä½œæ¥­éƒ¨ä¼šã®ç®¡ç†è€…ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è­°äº‹éŒ²ã€‚

å‰å›ã‹ã‚‰ä»Šå›ã®ä¼šè­°ã®é–“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®å ±å‘ŠãŒã•ã‚Œã¦ã„ã¾ã™ã€‚

### [N4915 Business Plan and Convener's Report: ISO/IEC JTC1/SC22/WG21 (C++)](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/n4915.pdf)

ãƒ“ã‚¸ãƒã‚¹ãƒ¦ãƒ¼ã‚¶å‘ã‘ã®C++ãŠã‚ˆã³WG21ã®ç¾çŠ¶å ±å‘Šæ›¸ã€‚

### [N4916 WG21 2022-07 Virtual Meeting Minutes of Meeting](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/n4916.pdf)

2022å¹´2æœˆ7æ—¥ï¼ˆåŒ—ç±³æ™‚é–“ï¼‰ã«è¡Œã‚ã‚ŒãŸã€WG21å…¨ä½“ä¼šè­°ã®è­°äº‹éŒ²ã€‚

CWG/LWG/LEWGã®æŠ•ç¥¨ã®æ§˜å­ãªã©ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

### [P0843R5 `static_vector`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p0843r5.html)

é™çš„ãªæœ€å¤§ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’æŒã¡ãƒ’ãƒ¼ãƒ—é ˜åŸŸã‚’ä½¿ç”¨ã—ãªã„`std::vector`ã§ã‚ã‚‹`static_vector`ã®ææ¡ˆã€‚

`static_vector<T, N>`ã¯`std::vector`ã¨`std::array`ã®ã‚­ãƒ¡ãƒ©ã®ã‚ˆã†ãªã‚³ãƒ³ãƒ†ãƒŠã§ã€`N`ã«æŒ‡å®šã—ãŸå€¤ã‚’æœ€å¤§ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã¨ã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã¯é™çš„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰ã‚’ç”¨ã„ã¦`std::vector`ã®ã‚ˆã†ãªå¯å¤‰é•·é…åˆ—ã‚’å®Ÿç¾ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

ä¸»ãŸã‚‹æ€§è³ªã¯

- å‹•çš„ãƒ¡ãƒ¢ãƒªç¢ºä¿ã‚’å¿…è¦ã¨ã—ãªã„
- ã‚¹ã‚¿ãƒƒã‚¯oré™çš„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹
- ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£æœ€å¤§å€¤ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æŒ‡å®šã•ã‚Œã‚‹
- è¦ç´ ã¯å¾Œã‹ã‚‰æŒ¿å…¥/å‰Šé™¤å¯èƒ½
- è¦ç´ ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯`static_vector`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã«é…ç½®ã•ã‚Œã‚‹
- `contiguous_range`ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’æº€ãŸã™
- è¦ç´ å‹`T`ãŒãƒˆãƒªãƒ“ã‚¢ãƒ«ã§ã‚ã‚Œã°ã€å…¨ã¦ã®æ“ä½œãŒå®šæ•°å¼ã§å¯èƒ½

ãªã©ã§ã€`static_vector`ã¯æ¬¡ã®ã‚ˆã†ãªå ´åˆã«æœ‰ç”¨ã§ã™

- å‹•çš„ãƒ¡ãƒ¢ãƒªç¢ºä¿ã‚’è¡Œãˆãªã„
    - ä¾‹ãˆã°ã€çµ„ã¿è¾¼ã¿ç’°å¢ƒãªã©
- å‹•çš„ãƒ¡ãƒ¢ãƒªç¢ºä¿ã®ã‚³ã‚¹ãƒˆãŒé«˜ãã¤ã
    - ä¾‹ãˆã°ã€ãƒ¡ãƒ¢ãƒªç¢ºä¿ã«ä¼´ã†ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã«æ•æ„Ÿãªãƒ—ãƒ­ã‚°ãƒ©ãƒ 
- é™çš„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¸Šã«ã€å¤‰å‰‡çš„ãªç”Ÿå­˜æœŸé–“ã‚’ã‚‚ã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã—ãŸã„
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ§‹ç¯‰ã§ããªã„å‹ã®é…åˆ—ãªã©ã€`std::array`ãŒé¸æŠè‚¢ã«ãªã‚‰ãªã„
- `constexpr`é–¢æ•°å†…ã§å¯å¤‰é•·é…åˆ—ã‚’ä½¿ç”¨ã—ãŸã„
    - ã“ã‚Œã¯C++20ä»¥é™`std::vector`ã§ã‚‚å¯èƒ½
- `static_vector`ã®è¦ç´ ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯`static_vector`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ãŒå†…åŒ…ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹
    - ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ãŸã‚ã®`memcpy`ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ãªã©

ã“ã®ææ¡ˆã®`static_vector`ã¯æ—¢å­˜å®Ÿè£…ã§ã‚ã‚‹`boost::container::static_vector`ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚„æ€§è³ªã¯`std::vector`ã¨ã®å…±é€šåŒ–ãŒå›³ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

```cpp
#include <static_vector> // <vector>ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„

int main() {
  std::static_vector<int, 8> sv = {1, 2, 3, 4};

  std::println("{}", sv); // [1, 2, 3, 4]

  sv.push_back(5);
  sv.emplace_back(6);

  std::print("{}", sv); // [1, 2, 3, 4, 5, 6]
}
```

ãªãŠã€æœ€å¤§ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’è¶…ãˆã¦è¦ç´ ã‚’æŒ¿å…¥ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã€å…¨ã¦ã®æ“ä½œã«ãŠã„ã¦äº‹å‰æ¡ä»¶é•åã¨ã—ã¦æœªå®šç¾©å‹•ä½œã¨ãªã‚Šã¾ã™ã€‚ä¾‹å¤–ã‚’æŠ•ã’ãŸãƒª`abort`ã—ãŸã‚Šã™ã‚‹ã®ã‹ã¯å®Ÿè£…ã®é¸æŠã¨ã•ã‚Œã¾ã™ã€‚

- [Boost.Container static_vector - Faith and Brave - C++ã§éŠã¼ã†](https://faithandbrave.hateblo.jp/entry/20130712/1373614497)
- [Class template static_vector - Boost](https://www.boost.org/doc/libs/1_80_0/doc/html/boost/container/static_vector.html)
- [P0843 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/114)

### [P1255R9 A view of 0 or 1 elements: views::maybe](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1255r9.pdf)

`std::optional`ã‚„ãƒã‚¤ãƒ³ã‚¿ç­‰ã®maybeãƒ¢ãƒŠãƒ‰ãªå¯¾è±¡ã‚’ã€ãã®çŠ¶æ…‹ã«ã‚ˆã£ã¦è¦ç´ æ•°0ã‹1ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«å¤‰æ›ã™ã‚‹Rangeã‚¢ãƒ€ãƒ—ã‚¿`views::maybe`ã®ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P1255R6 : A view of 0 or 1 elements: `views::maybe` - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´04æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/05/01/194425#P1255R6--A-view-of-0-or-1-elements-viewsmaybe)
- [P1255R7 : A view of 0 or 1 elements: `views::maybe` - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´05æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/06/11/191943#P1255R7-A-view-of-0-or-1-elements-viewsmaybe)
- [P1255R8 A view of 0 or 1 elements: `views::maybe` - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´07æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/08/11/193828#P1255R8-A-view-of-0-or-1-elements-viewsmaybe)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯

- `maybe_view`ã‹ã‚‰`nullable_view`ã‚’åˆ†é›¢
- `maybe_view/nullable_view`ã«`T&`ï¼ˆå·¦è¾ºå€¤å‚ç…§å‹ï¼‰ã®ç‰¹æ®ŠåŒ–ã‚’è¿½åŠ 
- `maybe_view`ã«ãƒ¢ãƒŠãƒ‡ã‚£ãƒƒã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¿½åŠ 
    - `and_then/or_else/transform`
- ãƒ•ãƒªãƒ¼ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ©Ÿèƒ½ã¨ã—ã¦æŒ‡å®š

ãªã©ã§ã™ã€‚

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§æ–°ãŸã«è¿½åŠ ã•ã‚ŒãŸ`nullable_view`ï¼ˆ`views::nullable`ï¼‰ã¯ã€`nullable_object`ã‚’`view`ã«å¤‰æ›ã™ã‚‹ã‚‚ã®ã§ã™ã€‚`nullable_object`ã¨ã¯æ–‡è„ˆçš„ãª`bool`å¤‰æ›ãŒå¯èƒ½ã§ã‚ã‚Šé–“æ¥å‚ç…§ãŒå¯èƒ½ãªå‹ã®ã“ã¨ã§ã€`void`ã§ã¯ãªã„ãƒã‚¤ãƒ³ã‚¿å‹ã‚„`std::optional`ã€`std::expected`ãªã©ãŒè©²å½“ã—ã¾ã™ã€‚ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿å‹ã¯é€šå¸¸å˜ä½“ã§`bool`å¤‰æ›ã§ããªã„ãŸã‚`nullable_object`ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```cpp
#include <ranges>

using std::ranges::nullable_view;

int main() {
  std::optional o{4};

  nullable_view m{o};
  for (int k : m) {
    cout << k;  // "4"ãŒå‡ºåŠ›
  }

  o = std::nullopt;
  nullable_view m2{o};
  for (int k : m2) {
    cout << k;  // å®Ÿè¡Œã•ã‚Œãªã„ï¼ˆãƒ«ãƒ¼ãƒ—ãŒå›ã‚‰ãªã„ï¼‰
  }
}
```

`nullable_view`ã¯ã€`nullable_object`å°‚ç”¨ã®`maybe_view`ã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã£ã¦ã€`maybe_view`ï¼ˆ`views::maybe`ï¼‰ã¯ã‚ˆã‚Šä¸€èˆ¬ã®å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`view`ã«å¤‰æ›ã™ã‚‹ã‚‚ã®ã¨ãªã‚Šã€`maybe_view`ãŒç©ºã«ãªã‚‹ã®ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ§‹ç¯‰ã•ã‚ŒãŸæ™‚ã§ã™ã€‚

```cpp
#include <ranges>

using std::ranges::maybe_view;

int main() {
  int i{4};

  maybe_view m{i};
  for (int k : m) {
    cout << k;  // "4"ãŒå‡ºåŠ›
  }

  maybe_view<int> m2{};
  for (int k : m2) {
    cout << k;  // å®Ÿè¡Œã•ã‚Œãªã„ï¼ˆãƒ«ãƒ¼ãƒ—ãŒå›ã‚‰ãªã„ï¼‰
  }
}
```

`maybe_view`ã‚‚`nullable_view`ã‚‚å…±ã«é•·ã•0ã‚‚ã—ãã¯1ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«ãªã‚Šã¾ã™ãŒã€`maybe_view`ã¯å€¤ã‚’æ¸¡ã—ã¦æ§‹ç¯‰ã•ã‚ŒãŸæ™‚ã«ã®ã¿é•·ã•1ã«ãªã‚‹ã®ã«å¯¾ã—ã¦ã€`nullable_view`ã¯æ¸¡ã•ã‚ŒãŸ`nullable_object`ã®çŠ¶æ…‹ã«ã‚ˆã£ã¦é•·ã•ãŒæ±ºã¾ã‚Šã¾ã™ã€‚

`nullable_view`ã¯ã“ã®ææ¡ˆã®å…ƒã€…ã®`maybe_view`ã§ã‚ã‚Šã€`nullable_object`ã§ã¯ç„¡ã„å‹ã«ã¤ã„ã¦`maybe_view`ã‚’æ‹¡å¼µã—ã‚ˆã†ã¨ã—ãŸçµæœã€1ã¤ã®ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…ã™ã‚‹ã®ã¯è‰²ã€…å•é¡ŒãŒã‚ã£ãŸãŸã‚ã€2ã¤ã®ã‚¯ãƒ©ã‚¹ï¼ˆã¨ã•ã‚‰ã«2ã¤ã®éƒ¨åˆ†ç‰¹æ®ŠåŒ–ï¼‰ã«åˆ†é›¢ã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚

- [P1255 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/60)

### [P2019R1 Usability improvements for `std::thread`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2019r1.pdf)

`std::thread/std::jthread`ã«ãŠã„ã¦ã€ãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã¨ã‚¹ãƒ¬ãƒƒãƒ‰åã‚’å®Ÿè¡Œé–‹å§‹å‰ã«è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ææ¡ˆã€‚

ç¾åœ¨ã®`std::thread/std::jthread`ã«ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã‚‚ã‚¹ãƒ¬ãƒƒãƒ‰åã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸€æ–¹ã§ã€ã“ã®2ã¤ã®ã‚¯ãƒ©ã‚¹ãŒä½¿ç”¨ã—ã¦ã„ã‚‹å®Ÿè¡Œç’°å¢ƒã®ã‚¹ãƒ¬ãƒƒãƒ‰APIã§ã¯ã€åºƒãã“ã®2ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¨­å®šãŒå¯èƒ½ã¨ãªã£ã¦ã„ã¾ã™ã€‚

|ç’°å¢ƒ|ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã®è¨­å®š|ã‚¹ãƒ¬ãƒƒãƒ‰åã®è¨­å®š|
|---|---|---|
|Linux, QNX|`pthread_attr_setstacksize()`|`pthread_setname_np()`|
|Windows|`CreateThread()`|`SetThreadDescription()`|
|Darwin|`pthread_attr_setstacksize()`|`pthread_setname_np()`|
|Fuchsia||`zx_thread_create()`|
|Android|`pthread_attr_setstacksize()`|`JavaVMAttachArgs()`|
|FreeBSD, OpenBSD, NetBSD|`pthread_attr_setstacksize()`|`pthread_setname_np()`|
|RTEMS|`pthread_attr_setstacksize()`|`pthread_setname_np()`|
|FreeRTOS|`xTaskCreate()`|`xTaskCreate()`|
|VxWorks|`taskSpawn()`|`taskSpawn()`|
|eCos|`cyg_thread_create()`|`cyg_thread_create()`|
|Plan 9|`threadcreate()`|`threadsetname()`|
|Haiku||`spawn_thread()`|
|Keil RTX||`osThreadNew()`|
|WebAssembly|||

â€» ç©ºç™½ã¯ãªã—ã€ã‚¹ãƒ¬ãƒƒãƒ‰åã®è¨­å®šã¯ä¸€éƒ¨äº‹å¾Œçš„ã«ã—ã‹è¡Œãˆãªã„ã‚‚ã®ãŒã‚ã‚‹

ã¾ãŸã€ä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚„C++ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¹ãƒ¬ãƒƒãƒ‰APIã«ãŠã„ã¦ã‚‚ã€ã“ã‚Œã‚‰ã«å¯¾å¿œã—ãŸæ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã‚‹å ´åˆãŒå¤šãã¿ã‚‰ã‚Œã¾ã™ã€‚

- ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã®è¨­å®š : Java, Rust, Python, C#, Haskell, D, Perl, Swift, Boost, Qt
- ã‚¹ãƒ¬ãƒƒãƒ‰åã®è¨­å®š : Rust, Python, D, C#, Java, Raku, Swift, Qt, Folly

ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã®è¨­å®šã¯ã€æ¬¡ã®ã‚ˆã†ãªå ´åˆã«å¿…è¦ã¨ãªã‚Šã¾ã™

- ç‰¹å®šã®ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç§»æ¤æ€§ã¨ä¿¡é ¼æ€§ã®ãŸã‚ã«ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–“ã§ä¸€è²«ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’æŒ‡å®šã™ã‚‹
- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šã‚‚å°ã•ã„ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’ä½¿ç”¨ã™ã‚‹
    - Windows : 1MB, Unix 2MB
    - å¤šæ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èµ·å‹•ã—ãŸã¨ãã«ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹ï¼ˆä»®æƒ³ãƒ¡ãƒ¢ãƒªã®ãªã„ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã„ã¦ï¼‰
- ä¸€éƒ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã«å¤§ããªã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¨­å®šã—ã€ãã“ã‹ã‚‰èµ·å‹•ã•ã‚ŒãŸã‚¹ãƒ¬ãƒƒãƒ‰ã«ã‚‚ç¶™æ‰¿ã•ã›ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã€‚ã“ã‚ŒãŒæœ›ã¾ã—ããªã„å ´åˆãŒã‚ã‚‹
- æœ‰åãªã‚²ãƒ¼ãƒ ã‚„å¤§è¦æ¨¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã§ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šã‚‚å¤§ãã„ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã‚ã‚‹

ã‚¹ãƒ¬ãƒƒãƒ‰åã¯ãƒ‡ãƒãƒƒã‚¬ã‚’å§‹ã‚ã¨ã™ã‚‹å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã«ãŠã„ã¦æœ‰ç”¨ã§ã€ä¸»ã«ãƒ‡ãƒãƒƒã‚°ã«æ´»ç”¨ã§ãã¾ã™

- ãƒ‡ãƒãƒƒã‚¬ãƒ¼ã«ãŠã‘ã‚‹åˆ©ç”¨
- å„ç¨®ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ€ãƒ³ãƒ—ã‚„å®Ÿè¡Œãƒˆãƒ¬ãƒ¼ã‚¹ãƒ„ãƒ¼ãƒ«
- ã‚¿ã‚¹ã‚¯/ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ‹ã‚¿
- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«/ãƒˆãƒ¬ãƒ¼ã‚¹/è¨ºæ–­ãƒ„ãƒ¼ãƒ«
- Windows Performance Analyzer, ETW tracing

ã“ã‚Œã‚‰ã®ã“ã¨ãŒæ¬ ã‘ã¦ã„ã‚‹äº‹ã«ã‚ˆã£ã¦ã€`std::thread`ã‚„`std::jthread`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ããšã€ã»ã¼åŒç­‰ã®ã‚¯ãƒ©ã‚¹ã‚’å†å®Ÿè£…ã—ãŸã‚Šã€åŸºåº•ã®APIã‚’ç›´æ¥ä½¿ç”¨ã—ãŸã‚Šã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ç­†è€…ã®æ–¹ã¯ã€ã€Œã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã®ã‚µãƒãƒ¼ãƒˆãŒãªã„ãŸã‚ã«`std::thread`ã‚’ä½¿ã†ã“ã¨ãŒã§ããšã€`std::thread`ã¯èªå½™å‹ã¨ã—ã¦å¤±æ•—ã—ã¦ã„ã‚‹ã€ã¨ã„ã†è©±ã‚’ã‚²ãƒ¼ãƒ é–‹ç™ºè€…ã®äººã€…ã‹ã‚‰èã„ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ã“ã®ææ¡ˆã¯ã€ãã‚Œã‚‰ã®æ—¢å­˜ã®ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æ¨™æº–åŒ–ã™ã‚‹ã“ã¨ã§ã€ç¾åœ¨`std::thread/std::jthread`ã‚’ä½¿ç”¨ã§ãã¦ã„ãªã„æ‰€ã§ä½¿ç”¨å¯èƒ½ã«ã—ã‚ˆã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

ã“ã“ã§ææ¡ˆã•ã‚Œã¦ã„ã‚‹APIã¯ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æŒ‡å®šã‚¯ãƒ©ã‚¹ã‚’`std::thread_attribute`ã‹ã‚‰ç¶™æ‰¿ã•ã›ã¦å®šç¾©ã—ãŸä¸Šã§ã€ãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`std::thread`ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å—ã‘å–ã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

```cpp
namespace std {
  // ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æŒ‡å®šè­˜åˆ¥ç”¨åŸºåº•ã‚¯ãƒ©ã‚¹
  class thread_attribute {};

  // ã‚¹ãƒ¬ãƒƒãƒ‰åã‚’æŒ‡å®šã™ã‚‹ã‚¯ãƒ©ã‚¹
  class thread_name : thread_attribute {
  public:
    constexpr thread_name(std::string_view name) noexcept;
    constexpr thread_name(std::u8string_view name) noexcept;
  private:
    implementation-defined __name[implementation-defined]; // èª¬æ˜å°‚ç”¨
  };

  // ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’æŒ‡å®šã™ã‚‹ã‚¯ãƒ©ã‚¹
  class thread_stack_size : thread_attribute {
  public:
    constexpr thread_stack_size(std::size_t size) noexcept;
  private:
    constexpr std::size_t __size; // èª¬æ˜å°‚ç”¨
  };


  class thread {
    ...

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼ˆå…ƒã‹ã‚‰ã‚ã‚‹
    thread() noexcept;

    // å‡¦ç†ã¨ãã®å¼•æ•°ã‚’å—ã‘å–ã‚‹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼ˆå…ƒã‹ã‚‰ã‚ã‚‹
    template<class F, class... Args>
    explicit thread(F&& f, Args&&... args);

    // å‡¦ç†ã¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æŒ‡å®šã‚’å—ã‘å–ã‚‹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼ˆã“ã®ææ¡ˆã§è¿½åŠ 
    template<class F, class... Attrs>
      requires (sizeof...(Attrs) != 0) &&
               ((is_base_of_v<thread_attribute, Attrs>) && ...) &&
               ...
    explicit thread(F&& f, Attrs&&... attrs);

    ...
  };

  // jthreadã‚‚åŒæ§˜ï¼ˆç•¥

}
```

`std::thread_name/std::thread_stack_size`ãŒæ¸¡ã•ã‚ŒãŸè¨­å®šå€¤ã‚’ã©ã®ã‚ˆã†ã«ä¿æŒã—ã¦å–ã‚Šå‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã‹ã¯å®Ÿè£…å®šç¾©ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚‚ã®ã‚’æ¬¡ã®ã‚ˆã†ã«ä½¿ç”¨ã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã«è¨­å®šã—ã¾ã™ã€‚

```cpp
void f();

int main() {
  // ã‚¹ãƒ¬ãƒƒãƒ‰åã¨ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã®æŒ‡å®š
  std::jthread thread(f, std::thread_name("Worker"),
                         std::thread_stack_size(512*1024));
  return 0;
}
```

æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¨­å®šå¯èƒ½ã§ãªã„å ´åˆï¼ˆä¾‹ãˆã°WASMç’°å¢ƒãªã©ï¼‰ã€å®Ÿè£…ã¯ã“ã®æŒ‡å®šã‚’ç„¡è¦–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æŒ‡å®šã®æ–¹æ³•ã¯ã“ã®2ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä»¥å¤–ã«ã‚‚æ‹¡å¼µå¯èƒ½ã§ã€ä¾‹ãˆã°ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¢ãƒ•ã‚£ãƒ‹ãƒ†ã‚£ã‚„å„ªå…ˆåº¦ã‚’æŒ‡å®šå¯èƒ½ã¨ã™ã‚‹ã“ã¨ã‚‚å°†æ¥çš„ã«ã¯å¯èƒ½ãªã‚ˆã†ã«ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¨ã¯ã„ãˆã€ã“ã®ææ¡ˆã§ã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã¨ã‚¹ãƒ¬ãƒƒãƒ‰åã®2ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿ã‚’ææ¡ˆã—ã¦ã„ã¾ã™ã€‚

- [P2019 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/817)

### [P2164R6 `views::enumerate`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2164r6.pdf)

å…ƒã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®å„è¦ç´ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç´ä»˜ã‘ãŸè¦ç´ ã‹ã‚‰ãªã‚‹æ–°ã—ã„ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹Rangeã‚¢ãƒ€ãƒ—ã‚¿`views::enumrate`ã®ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2164R0 views::enumerate - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´5æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/06/01/001003#P2164R0--viewsenumerate)
- [P2164R1 views::enumerate - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´6æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/07/05/003248#P2164R1--viewsenumerate)
- [P2164R2 views::enumerate - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´9æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/10/09/221025#P2164R2--viewsenumerate)
- [P2164R3 views::enumerate - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´11æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/12/06/015108#P2164R3-viewsenumerate)
- [P2164R4 views::enumerate - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´02æœˆï¼‰](https://onihusube.hatenablog.com/#P2164R4-viewsenumerate)
- [P2164R5 views::enumerate - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´06æœˆï¼‰](https://onihusube.hatenablog.com/#P2164R4-viewsenumerate)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€`enumerate_result`ã‚’èª¬æ˜å°‚ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ`tuple-like`ã‚’æº€ãŸã™å‹ã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ãŸã“ã¨ã€`enumerate_view::iterator::operator*`ã¯å€¤ï¼ˆ*prvalue*ï¼‰ã‚’è¿”ã™ãŸã‚Cpp17ForwardIteratorã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’æº€ãŸã™äº‹ãŒã§ããšã€ãã‚Œã«å¿œã˜ãŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚«ãƒ†ã‚´ãƒªã‚’èª¿æ•´ã—ãŸã“ã¨ãªã©ã§ã™ã€‚

- [P2164 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/875)

### [P2264R4 Make assert() macro user friendly for C and C++](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2264r4.html)

`assert`ãƒã‚¯ãƒ­ã‚’C++ã®æ§‹æ–‡ã«é¦´æŸ“ã‚€ã‚ˆã†ã«ç½®ãæ›ãˆã‚‹ææ¡ˆã€‚

- [P2264R0 Make assert() macro user friendly for C and C++  - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´12æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/01/17/005823#P2264R0-Make-assert-macro-user-friendly-for-C-and-C)
- [P2264R2 Make assert() macro user friendly for C and C++  - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´10æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/11/13/193322#P2264R2-Make-assert-macro-user-friendly-for-C-and-C)
- [P2264R3 Make assert() macro user friendly for C and C++  - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´03æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/04/02/175835#P2264R3-Make-assert-macro-user-friendly-for-C-and-C)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€Cã§ã®æ¡ç”¨ã«ä¼´ã†æ–‡æ›¸ã®èª¿æ•´ãªã©ã§ã™ã€‚

- [P2264 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/957)

### [P2477R3 Allow programmers to control coroutine elision](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2477r3.html)

ã‚³ãƒ«ãƒ¼ãƒãƒ³ã®å‹•çš„ãƒ¡ãƒ¢ãƒªç¢ºä¿ã‚’é¿ã‘ã‚‹æœ€é©åŒ–ã‚’åˆ¶å¾¡ã™ã‚‹APIã‚’è¿½åŠ ã™ã‚‹ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2477R0 Allow programmer to control and detect coroutine elision by static constexpr bool should_elide() and - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´10æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/11/13/193322#P2477R0-Allow-programmer-to-control-and-detect-coroutine-elision-by-static-constexpr-bool-should_elide-and)
- [P2477R2 Allow programmer to control and detect coroutine elision - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´09æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/12/11/220126#P2477R2-Allow-programmer-to-control-and-detect-coroutine-elision)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€

- `promise_type::must_elide(P0, ..., Pn)`ãŒæœ€åˆã«è©•ä¾¡ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚’ææ¡ˆ
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒå‡¦ç†ï¼ˆæœ€é©åŒ–ï¼‰ã§ããªã„éåŒæœŸã‚±ãƒ¼ã‚¹ã®ä¾‹ã‚’è¿½åŠ 
    - ã“ã®ææ¡ˆã®APIãŒå¿…è¦ã§ã‚ã‚‹ã‚±ãƒ¼ã‚¹
- æœ€é©åŒ–ãŒèµ·ããŸã“ã¨ã‚’æ¤œå‡ºã™ã‚‹APIã‚’ææ¡ˆã‹ã‚‰å¤–ã—ãŸ
    - ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã¦ã„ãŸãŸã‚
- æœ€é©åŒ–ã¨ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã«ã¤ã„ã¦ã®è­°è«–ã‚’è¿½åŠ 
- ä¾‹ã‚’è¿½åŠ 

ãªã©ã§ã™ã€‚

- [P2477 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1133)

### [P2511R2 Beyond `operator()`: NTTP callables in type-erased call wrappers](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2511r2.html)

`std::move_only_fuction`åŠã³`std::function`ã‚’ã€å‘¼ã³å‡ºã—å¯èƒ½ãªNTTPå€¤ã‚’å‹æ¶ˆå»ã™ã‚‹Callable Wrapperã¸æ‹¡å¼µã™ã‚‹ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2511R0 Beyond `operator()`: NTTP callables in type-erased call wrappers - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´01æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/01/10/235544#P2510R0-Formatting-pointers)
- [P2511R1 Beyond `operator()`: NTTP callables in type-erased call wrappers - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´03æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/04/02/175835#P2511R1-Beyond-operator-NTTP-callables-in-type-erased-call-wrappers)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒã‚¯ãƒ­ã‚’è¿½åŠ ã—ãŸã“ã¨ã€å®Ÿè£…çµŒé¨“ã‚’è¿½åŠ ã—ãŸã“ã¨ã§ã™ã€‚

- [P2511 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1169)

### [P2517R1 Add a conditional noexcept specification to std::apply](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2517r1.html)

`std::apply`ã«`noexcept`æŒ‡å®šã‚’è¡Œã†ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2517R0 Add a conditional noexcept specification to std::apply - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´01æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/02/19/181101#P2517R0-Add-a-conditional-noexcept-specification-to-stdapply)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€ææ¡ˆã™ã‚‹æ–‡è¨€ã®ä¿®æ­£ã¨ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‰ãƒ©ãƒ•ãƒˆã®æ›´æ–°ã§ã™ã€‚

ã“ã®ææ¡ˆã¯æ—¢ã«ã€2022å¹´7æœˆã®å…¨ä½“ä¼šè­°ã§æ‰¿èªã•ã‚Œã€C++23ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‰ãƒ©ãƒ•ãƒˆå…¥ã‚Šã—ã¦ã„ã¾ã™ã€‚

- [P2517 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1175)

### [P2537R1 Relax va_start Requirements to Match C](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2537r1.html)

å¯å¤‰é•·å¼•æ•°é–¢æ•°ã‚’0å€‹ã®å¼•æ•°ã§å®£è¨€ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2537R0 Relax va_start Requirements to Match C - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´02æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/03/19/224729#P2537R0-Relax-va_start-Requirements-to-Match-C)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€C23ã®ææ¡ˆï¼ˆN2975ã€C23ã«å°å…¥æ¸ˆã¿ï¼‰ã«ä»•æ§˜ã‚’æ•´åˆã•ã›ãŸã“ã¨ã§ã™ã€‚

- [P2537 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1200)

### [P2581R1 Specifying the Interoperability of Built Module Interface Files](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2581r1.pdf)

ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ‰±ã†éš›ã«ã€ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ãŒãã®ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥æ‰±ã†ã“ã¨ãŒã§ãã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2581R0 Specifying the Interoperability of Binary Module Interface Files - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´05æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/06/11/191943#P2581R0-Specifying-the-Interoperability-of-Binary-Module-Interface-Files)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯

- *Binary Module Interface*ã¨ã„ã†ç”¨èªã‚’*Built Module Interface*ã«ç½®ãæ›ãˆãŸ
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ç¿»è¨³å˜ä½ã¨ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ç¿»è¨³å˜ä½ã®é–“ã§ã€ç‹¬ç«‹ã—ãŸãƒ‘ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒã¤ã“ã¨ã«ã¤ã„ã¦ã®èª¿æŸ»ã«é–¢ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
- èª­ã¿ã‚„ã™ã•å‘ä¸Šã®ãŸã‚ã®èª¿æ•´

- [P2581 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1241)

### [P2587R2 to_string or not to_string](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2587r2.html)
### [P2611R0 2022-07 Library Evolution Poll Outcomes](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2611r0.html)

2022å¹´ã®7æœˆã«è¡Œã‚ã‚ŒãŸã€LEWGã§ã®å…¨ä½“æŠ•ç¥¨ã®çµæœã€‚

æ¬¡ã®ææ¡ˆãŒã€LWGã«è»¢é€ã•ã‚Œã‚‹ã“ã¨ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ

- C++23
    - [P0429R9 flat_map](https://wg21.link/P0429R9)
    - [P1222R4 flat_set](https://wg21.link/P1222R4)
    - [P0792R10 function_ref](https://wg21.link/P0792R10)
    - [P2505R4 Monadic Functions For expected](https://wg21.link/P2505R4)
    - [P2585R0 Improving Default Container Formatting](https://wg21.link/P2585R0)
    - [P2446R2 views::as_rvalue](https://wg21.link/P2446R2)
    - [P2278R4 cbegin Should Always Return A Constant Iterator](https://wg21.link/P2278R4)
    - [P2248R5 Enabling List-Initialization For Algorithms](https://wg21.link/P2248R5)
    - [P2539R1 Should The Output Of print To A Terminal Be Synchronized With The Underlying Stream?](https://wg21.link/P2539R1)
    - [P2551R2 Clarify Intent Of Individually Specializable Numeric Traits](https://wg21.link/P2551R2)
    - [P2599R2 index_type & size_type In mdspan](https://wg21.link/P2599R2)
    - [P2604R0 mdspan: Rename pointer, data, And contiguous](https://wg21.link/P2604R0)
    - [P2613R1 Add The Missing empty To mdspan](https://wg21.link/P2613R1)
- C++26
    - [P2338R2 Freestanding Library: Character Primitives And The C Library](https://wg21.link/P2338R2)
    - [P2407R1 Freestanding Library: Partial Classes](https://wg21.link/P2407R1)
    - [P2562R1 constexpr Stable Sorting](https://wg21.link/P2562R1)
    - [P2283R2 constexpr Specialized Memory Algorithms](https://wg21.link/P2283R2)
    - [P2542R2 views::concat](https://wg21.link/P2542R2)
    - [P2609R1 Relaxing Ranges Just A Smidge](https://wg21.link/P2609R1)

C++23å‘ã‘ã®ææ¡ˆã®ä¸€éƒ¨ã¯ã€7æœˆã®å…¨ä½“ä¼šè­°ã§C++23ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‰ãƒ©ãƒ•ãƒˆå…¥ã‚ŠãŒæ‰¿èªã•ã‚ŒãŸã‚‚ã®ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆå…¨ä½“ä¼šè­°ã§ã¯ã“ã‚Œã«ã¤ã„ã¦LWGã®åº§é•·ãŒè‹¦è¨€ã‚’å‘ˆã—ã¦ã„ãŸã‚ˆã†ã§ã™ãŒãƒ»ãƒ»ãƒ»ï¼‰ã€‚

ã¾ãŸã€æŠ•ç¥¨ã«ã‚ãŸã£ã¦å¯„ã›ã‚‰ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

### [P2620R1 Lifting artificial restriction on universal character names](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2620r1.pdf)
### [P2621R1 UB? In my Lexer?](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2621r1.pdf)
### [P2623R1 implicit constant initialization](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2623r1.html)
### [P2625R0 Slides: Life without operator() (P2511R1 presentation)](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2625r0.pdf)

P2511ï¼ˆ`std::nontype`ï¼‰ã®è§£èª¬ã‚¹ãƒ©ã‚¤ãƒ‰ã€‚

P2511ã¯`std::function, std::move_only_function`ï¼ˆå°†æ¥çš„ã«ã¯`std::function_ref`ã«ã‚‚ï¼‰ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãªãç°¡æ˜“ãªãƒ¡ãƒ³ãƒãƒã‚¤ãƒ³ã‚¿ã‚µãƒãƒ¼ãƒˆã‚’å…¥ã‚Œã‚ˆã†ã¨ã™ã‚‹ææ¡ˆã§ã™ã€‚è©³ç´°ã¯ä»¥å‰ã®è¨˜äº‹å‚ç…§

- [P2511R0 Beyond `operator()`: NTTP callables in type-erased call wrappers - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´01æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/02/19/181101#P2511R0-Beyond-operator-NTTP-callables-in-type-erased-call-wrappers)
- [P2511R1 Beyond `operator()`: NTTP callables in type-erased call wrappers - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´03æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/02/19/181101#P2511R0-Beyond-operator-NTTP-callables-in-type-erased-call-wrappers)

ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¯LEWGã®ãƒ¡ãƒ³ãƒã«å‘ã‘ã¦P2511ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚„åˆ©ç‚¹ã€ä½¿ç”¨æ„Ÿã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

### [P2626R0 `charN_t` incremental adoption: Casting pointers of UTF character types](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2626r0.pdf)

äº’æ›æ€§ã®ã‚ã‚‹ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—è¡¨ç¾ã‚’æŒã¤ç•°ãªã‚‹å‹ã®é–“ã§ã®åˆæ³•çš„ãªãƒã‚¤ãƒ³ã‚¿ã‚­ãƒ£ã‚¹ãƒˆã‚’è¡Œã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ©Ÿèƒ½ã®ææ¡ˆã€‚

`char8_t, char16_t, char32_t`ï¼ˆä»¥é™ã€ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—å‹ï¼‰ãªã©ã®ç™»å ´å‰ã€C++ã§ã¯ä»»æ„ã®ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—ï¼ˆåˆ—ï¼‰ã‚’è¡¨ã™ã®ã«`char`ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¤ãƒˆå˜ä½ã§ãã‚Œã‚‰ã‚’æ‰±ã†ã“ã¨ãŒã‚ˆãè¡Œã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€`char`ã¯ãã‚Œè‡ªèº«ãŒæ–‡å­—å‹ã§ã‚ã‚Šã€ã—ã°ã—ã°ãã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯UTF-8ã§ã¯ãªãã€æ•´æ•°å‹ã‚„ãƒã‚¤ãƒˆå‹ã¨åŒºåˆ¥ã•ã‚Œãšã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚`char`ã¯æ–‡å­—ã€ç‰¹ã«ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—ã‚’è¡¨ã™å‹ã¨ã—ã¦ã¯é©åˆ‡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãã®ã‚ˆã†ãªèƒŒæ™¯ã‚‚ã‚ã£ã¦C++11ã§`char16_t, char32_t`ãŒã€C++20ã§`char8_t`ãŒå°å…¥ã•ã‚Œã€ã“ã‚Œã‚‰ã‚’ç”¨ã„ã¦å‹ã«ã‚ˆã£ã¦æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¾ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã—ã‹ã—ã€C++20ã‚ã‚‹ã„ã¯C++11ä»¥å‰ã‹ã‚‰ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã¯å‰è¿°ã®`char`ã‚’ç”¨ã„ãŸãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãŒæ®‹ã£ã¦ãŠã‚Šã€ã¾ãŸ`wchar_t`ç­‰åˆ¥ã®æ–¹æ³•ã§ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—ï¼ˆåˆ—ï¼‰ã‚’è¡¨ç¾ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå¤šæ•°å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚ãã‚Œã‚‰ã®æ–¹æ³•ã§è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã¨ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—å‹ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«ã‚ˆã‚‹ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã¨ã®é–“ã§ã‚³ãƒ”ãƒ¼ã‚„æœªå®šç¾©å‹•ä½œã‚’ä¼´ã†ã“ã¨ãªãå¤‰æ›ã™ã‚‹æ–¹æ³•ãŒãªã„ã“ã¨ã‹ã‚‰ã€ãã‚Œã‚‰ã®ãƒ¬ã‚¬ã‚·ãƒ¼ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—å‹ã‚’ã‚¢ãƒ€ãƒ—ãƒˆã§ããšã€ãã‚Œã«ã‚ˆã£ã¦ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—å‹ã®ä½¿ç”¨ãŒå¦¨ã’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ææ¡ˆã¯ã€ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—å‹ã¨æ—¢å­˜ã®`char`æ–‡å­—åˆ—ã‚„`wchar_t`æ–‡å­—åˆ—ãªã©ã¨ã®é–“ã§ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä»®å®šã—ãã‚Œã‚’ä¿æŒã—ãŸã¾ã¾å¤‰æ›ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ãã®ã‚ˆã†ãªå•é¡Œã‚’è§£æ±ºã—ã‚ˆã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

ã“ã“ã§ææ¡ˆã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€æ¬¡ã®2ã¤ã®é–¢æ•°ã§ã™

- `std::cast_as_utf_unchecked()` : `std::byte, char, wchar_t`ã‚ã‚‹ã„ã¯ã‚µã‚¤ã‚º`N`ã®ç¬¦å·ãªã—æ•´æ•°å‹ã®ãƒã‚¤ãƒ³ã‚¿ã‹ã‚‰ã€`charN_t`ã®ãƒã‚¤ãƒ³ã‚¿ã¸å¤‰æ›ã™ã‚‹
- `std::cast_utf_to<T>()` : `charN_t`ã®ãƒã‚¤ãƒ³ã‚¿ã‹ã‚‰`T`ã®ãƒã‚¤ãƒ³ã‚¿ã¸å¤‰æ›ã™ã‚‹
  - `T`ã¯`std::byte, char, wchar_t`ã‚ã‚‹ã„ã¯ã‚µã‚¤ã‚º`N`ã®ç¬¦å·ãªã—æ•´æ•°å‹
  - `std::cast_as_utf_unchecked()`ã®é€†å¤‰æ›

ã“ã®2ã¤ã®é–¢æ•°ã¯`std::start_lifetime_as_array()`ã‚’é©åˆ‡ã«ãã®æ–‡å­—åˆ—ã«å¯¾ã—ã¦é©ç”¨ã™ã‚‹ã®ã¨ä¼¼ãŸã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’æŒã¡ã€ã‚½ãƒ¼ã‚¹é ˜åŸŸã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã‚’çµ‚äº†ã•ã›ã€æŒ‡å®šã•ã‚ŒãŸå‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã‚’ãã®å€¤ã‚’ä¿ã£ãŸã¾ã¾é–‹å§‹ã•ã›ã¾ã™ã€‚ãŸã ã—ã€å˜ãªã‚‹`constexpr std::start_lifetime_as_array()`ã§ã¯ãªãã€é©åˆ‡ãªæ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã«ã€è¿½åŠ ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚µãƒãƒ¼ãƒˆã‚’å¿…è¦ã¨ã—ã¾ã™ã€‚

æœ‰åŠ¹ãªå¤‰æ›ã®ä¾‹

||`char8_t`|`char16_t`|`char32_t`|
|---|:-:|:-:|:-:|
|`char`|âœ…|âŒ|âŒ|
|`unsigned char`|âœ…|âŒ|âŒ|
|`uit_least_16_t`|âŒ|âœ…|âŒ|
|`uit_least_32_t`|âŒ|âŒ|âœ…|
|`wchar_t`|â—ï¸|â—ï¸|â—ï¸|
|`std::byte`|âœ…|âŒ|âŒ|

è¡Œè¦ç´ ->åˆ—è¦ç´  : `std::cast_as_utf_unchecked()`
åˆ—è¦ç´ ->è¡Œè¦ç´  : `std::cast_utf_to<T>()`

è¡¨ä¸­ã®â—ï¸ã¯å®Ÿè£…å®šç¾©ã§ã‚ã‚‹ã“ã¨ã‚’è¡¨ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®é–¢æ•°ã¯ãã®å¤‰æ›ã«ã‚ãŸã£ã¦å®Ÿéš›ã«ãã®å¤‰æ›ãŒæœ‰åŠ¹ãªã®ã‹ã¨ã‹ã€æ–‡å­—ãŒãã¡ã‚“ã¨å¤‰æ›å…ˆã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ãªã£ã¦ã„ã‚‹ã®ã‹ãªã©ã®ãƒã‚§ãƒƒã‚¯ã‚’ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ãŒã€ã“ã‚Œã‚‰ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ãŸå¤‰æ›ã¯ãã®æ„å›³ã‚’ã‚³ãƒ¼ãƒ‰ã«åæ˜ ã•ã›ã‚‹æ„å‘³ã‚‚æŒã¡ã¾ã™ã€‚ä¾‹ãˆã°ã€`std::cast_as_utf_unchecked()`ã«ã‚ˆã£ã¦`char8_t`ã«å¤‰æ›ã™ã‚‹å ´åˆã€å¤‰æ›å¾Œã®æ–‡å­—åˆ—ã¯UTF-8ã®æ­£ã—ã„ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã§ã‚ã‚Šãã†ãªã£ã¦ã„ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã“ã®ã‚ˆã†ã«ã€æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ã¤ã„ã¦ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒã®æš—é»™çš„ãªä»®å®šã‚’ã‚³ãƒ¼ãƒ‰ä¸Šã§æ˜ç¢ºã«ã™ã‚‹å½¹å‰²ã‚’æ‹…ã£ã¦ã‚‚ã„ã¾ã™ã€‚

```cpp
// ç¾åœ¨ã‚ˆãè©¦ã¿ã‚‰ã‚Œã‚‹æ–¹æ³•
void before() {
  // å…¥åŠ›æ–‡å­—åˆ—ï¼ˆwchar_tã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’UTF-16ã¨ã™ã‚‹ï¼‰
  const wchar_t* str = L"Hello ğŸŒ";

  // å¤šãã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ: ill-formed
  const char16_t* u = static_cast<const char16_t*>(str);

  // çµŒé¨“10å¹´ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ: UB
  const char16_t* u = reinterpret_cast<const char16_t*>(str);

  // Cã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: UB in C++
  const char16_t* u = (const char16_t*)(str);

  // rangesã®åˆ©ç”¨: O(n)ã‹ã‹ã‚‹ã€contiguous_rangeã§ãªããªã‚‹
  auto v = std::wstring_view(str) | std::views::transform(std::bit_cast<char16_t, wchar_t>);

  // åˆ¥ã®ãƒ¡ãƒ¢ãƒªã«ã‚³ãƒ”ãƒ¼: O(n)ã€å‹•çš„ç¢ºä¿
  auto v = std::wstring_view(str) | std::views::transform(std::bit_cast<char16_t, char16_t>) 
                                  | std::to<std::vector>;

  // launderã®åˆ©ç”¨: ã¾ã UB
  const char16_t* u = std::launder(reinterpret_cast<const char16_t*>(str));

  // ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ: constexprã§ã¯ãªã„
  const char16_t* u = std::start_lifetime_as_array(reinterpret_cast<const char16_t*>(str), std::char_traits<wchar_t>::length(str));
}

// ã“ã®ææ¡ˆ
void after() {
  // ã‚³ãƒ”ãƒ¼ãªã—ã€UBãªã—ã€constexprã€æ˜ç¢ºãªã›ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’æŒã¡å®Ÿéš›ã«ã¯ä½•ã‚‚ã—ãªã„
  constexpr std::u16_string_view v = std::cast_as_utf_unchecked(L"Hello"sv);
}
```

åˆ©ä¾¿æ€§å‘ä¸Šã®ãŸã‚ã€`std::cast_as_utf_unchecked()`ã¨`std::cast_utf_to<T>()`ã«ã¯ãã‚Œãã‚Œã€`string_view`ã¨`span`ã‚’å—ã‘å–ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ãŒç”¨æ„ã•ã‚Œã¾ã™ã€‚

- [P2590R0 Explicit lifetime management - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´05æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/06/11/191943#P2590R0-Explicit-lifetime-management)
- [P2626 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1289)

### [P2627R0 WG21 2022-07 Virtual Meeting Record of Discussion](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2627r0.pdf)

2022/07ã®å…¨ä½“ä¼šè­°ã®è­°äº‹éŒ²ã€‚

N4916ã®ã‚‚ã®ã‚ˆã‚Šã‚‚ã€èª°ãŒã©ã®ã‚ˆã†ãªç™ºè¨€ã‚’ã—ãŸã‹ãŒè©³ã—ãè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚

### [P2628R0 Extend barrier APIs with memory_order](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2628r0.html)

`std::barrier`ã®å„æ“ä½œã«ã€ãƒ¡ãƒ¢ãƒªã‚ªãƒ¼ãƒ€ãƒ¼ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ææ¡ˆã€‚

[`std::barrier`](https://cpprefjp.github.io/reference/barrier/barrier.html)ã¯C++20ã§è¿½åŠ ã•ã‚ŒãŸã€è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã®é€²è¡Œç®¡ç†ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã®ã§ãã‚‹åŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã§ã™ã€‚ãã®å®Ÿä½“ã¯ã‚«ã‚¦ãƒ³ã‚¿ã§ã‚ã‚Šã€`.arrive()`ã«ã‚ˆã£ã¦ã‚«ã‚¦ãƒ³ã‚¿æ¸›ç®—ã‚’ã€`.wait()`ã«ã‚ˆã£ã¦ã‚«ã‚¦ãƒ³ã‚¿ãƒªã‚»ãƒƒãƒˆã¾ã§ã®å¾…æ©Ÿã‚’è¡Œã„ã¾ã™ã€‚ã»ã‹ã«ã‚‚ã€ãã‚Œã‚‰ã®è¤‡åˆæ“ä½œã§ã‚ã‚‹`.aarrive_and_wait()`ã€åŒæœŸã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰é€”ä¸­é›¢è„±ã™ã‚‹ãŸã‚ã®`.arrive_and_drop()`ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®`std::barrier`ã®APIã¯å…¨ã¦ãƒ¡ãƒ¢ãƒªã‚ªãƒ¼ãƒ€ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã§ã¯ãªãã€`.arrive()`ã‚ˆã‚Šã‚‚å‰ã«è¡Œã‚ã‚ŒãŸå…¨ã¦ã®ãƒ¡ãƒ¢ãƒªæ“ä½œã¯ã€`.wait()`ã«ã‚ˆã‚‹å¾…æ©Ÿè§£é™¤å¾Œã«å¯è¦–ã«ãªã‚‹ã“ã¨ãŒï¼ˆã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«æ¸¡ã£ã¦ï¼‰ä¿è¨¼ã•ã‚Œã¾ã™ã€‚

ã“ã®ä¿è¨¼ã¯ã‹ãªã‚Šå¼·ã„ã‚‚ã®ã§ã€å ´åˆã«ã‚ˆã£ã¦ã¯ã“ã®ä¿è¨¼ãŒæœ›ã¾ã—ããªã„å ´åˆãŒã‚ã‚Šã¾ã™

1. C++ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å¤–éƒ¨ã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹å ´åˆ
    - ä¾‹ãˆã°ã€ãƒãƒªã‚¢ã«å‚åŠ ã™ã‚‹ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãã‚Œãã‚Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦èª­ã¿æ›¸ãã™ã‚‹æ™‚ã€`.arrive_and_wait(1, memory_order_relaxed)`ã«ã‚ˆã£ã¦ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‰ã˜ãŸã“ã¨ã‚’åŒæœŸã™ã‚‹ã€‚
      - ã“ã®å ´åˆã€ãƒ¡ãƒ¢ãƒªã®å¯è¦–æ€§ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒ­ãƒ¼ã‚ºã®å¯è¦–æ€§ï¼‰ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç¢ºä¿ã•ã‚Œã‚‹
    - ä¾‹ãˆã°ã€ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯`volatile`æ“ä½œã«ã‚ˆã£ã¦å®Ÿè¡Œç’°å¢ƒï¼ˆãƒã‚·ãƒ³ï¼‰ã®è¨­å®šã‚’è¡Œã£ã¦ã‹ã‚‰ã€ãã®ä¸­ã®1ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒç’°å¢ƒã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã•ã›ã‚‹ã‚ˆã†ãªå ´åˆã€‚ã“ã‚Œã¯ã€`memory_order_relaxed`ãª`.arrive()/.wait()`æ“ä½œã¨ã€`std::barrier`ã®å®Œäº†é–¢æ•°ã«ã‚ˆã£ã¦å®Ÿç¾ã§ãã‚‹ã€‚
      - ã“ã®å ´åˆã€`volatile`ãªæ›¸ãè¾¼ã¿ãŒç’°å¢ƒé–‹å§‹æ™‚ï¼ˆå¾…æ©Ÿè§£é™¤å¾Œï¼‰ã«å¯è¦–ã«ãªã£ã¦ã„ã‚Œã°ã‚ˆãã€ãã‚Œã¯`volatile`æ“ä½œã«ã‚ˆã£ã¦ä¿è¨¼ã•ã‚Œã‚‹ã€‚
2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚§ãƒ³ã‚¹ï¼ˆ[P2535](https://wg21.link/P2535)ï¼‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ
    - ä¸€éƒ¨ã®ãƒ¡ãƒ¢ãƒªæ“ä½œã«ã¤ã„ã¦ã®ã¿å¯è¦–ã«ãªã‚Œã°ã‚ˆãã€ã™ã¹ã¦ã®ãƒ¡ãƒ¢ãƒªæ“ä½œã«ãã®ä¿è¨¼ã¯å¿…è¦ãªã„

ã“ã®ææ¡ˆã¯ã€ã“ã‚Œã‚‰ã®å ´åˆãªã©ã«ã€`std::barrier`ã‚’ç”¨ã„ãŸã‚ˆã‚ŠåŠ¹ç‡çš„ãªåŒæœŸã‚’å¯èƒ½ã¨ã™ã‚‹ãŸã‚ã«ã€`std::barrier`ã®APIãŒ`std::memory_order`ã‚’è¿½åŠ ã§å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«æ‹¡å¼µã—ã‚ˆã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

ä¸Šè¨˜2ã®ã‚±ãƒ¼ã‚¹ã®ã‚µãƒ³ãƒ—ãƒ«

<table>
<tr>
<th>ç¾åœ¨</th>
<th>ã“ã®ææ¡ˆ</th>
</tr>
<tr>
<td valign="top">

```cpp
// Thread 0:
x = 1;
atomic_object_fence(memory_order_release, x);
bar.arrive(); // release fence

// Thread 1
bar.arrive_and_wait(); // acquire fence
atomic_object_fence(memory_order_acquire, x);
assert(x == 1);
```

</td>
<td valign="top">

```cpp
// Thread 0:
x = 1;
atomic_object_fence(memory_order_release, x);
bar.arrive(1, memory_order_relaxed); // no fence

// Thread 1
bar.arrive_and_wait(memory_order_relaxed); // no fence
atomic_object_fence(memory_order_acquire, x);
assert(x == 1);
```

</pre>
</td>
</tr>
</table>

ç¾åœ¨ã®ä¾‹ã§ã¯ã€ã“ã®å ´åˆã®`atomic_object_fence`ã¯æ„å‘³ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ`std::barrier`ãŒã‚ˆã‚Šå¼·ã„åŒæœŸã‚’ä¿è¨¼ã—ã¦ã„ã‚‹ãŸã‚ï¼‰ã€‚ã“ã®ææ¡ˆå¾Œã€`memory_order_relaxed`ã¨å…±ã«`std::barrier`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§`std::barrier`ã®ä¿è¨¼ãŒã»ã¼ãªããªã‚Šã€`atomic_object_fence`ã«ã‚ˆã£ã¦ç‰¹å®šã®å¤‰æ•°ã®ãƒ¡ãƒ¢ãƒªå¯è¦–æ€§ã®ã¿ãŒä¿è¨¼ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆãã‚Œã«ã‚ˆã£ã¦ã€åŒæœŸã®ã‚³ã‚¹ãƒˆä½æ¸›ãŒå¯èƒ½ã¨ãªã‚Šã†ã‚‹ï¼‰ã€‚

ã“ã®ææ¡ˆã®å†…å®¹ã¯`std::latch`ã‚’ã¯ã˜ã‚ã¨ã—ãŸä»–ã®åŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã«ã‚‚é©ç”¨å¯èƒ½ã§ã™ãŒã€ã“ã®ææ¡ˆã§ã¯ç¾åœ¨ã®ã¨ã“ã‚ã€`std::barrier`ã«ã®ã¿ç„¦ç‚¹ã‚’çµã£ã¦ã„ã¾ã™ã€‚

- [C++20 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ©Ÿèƒ½ 1](https://github.com/onihusube/books/blob/master/cpp20_lib/document.md#latch%E3%81%A8barrier)
- [P2535R0 Message fences - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´02æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/03/19/224729#P2535R0-Message-fences)
- [P2628 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1291)

### [P2629R0 `barrier` token-less split `arrive/wait`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2629r0.html)

`std::barrier`ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè£…ã«ãŠã„ã¦ã‚ˆã‚ŠåŠ¹ç‡çš„ã«ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«æ‹¡å¼µã™ã‚‹ææ¡ˆã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãƒ¢ãƒ‡ãƒ«ã®ä¸€ã¤ã§ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®1é€£ã®æµã‚Œã‚’ä¸¦åˆ—åŒ–å¯èƒ½ãªãƒ–ãƒ­ãƒƒã‚¯ã«åŒºåˆ‡ã‚Šã€ãã‚Œã‚‰å‡¦ç†ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŒ–ã™ã‚‹ã“ã¨ã§é«˜é€ŸåŒ–ã‚’å›³ã‚‹ã‚‚ã®ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚‹å‡¦ç†ã¯ä¾‹ãˆã°ã€ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„HPCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ä¸€èˆ¬çš„ã«è¡Œã‚ã‚Œã„ã¾ã™ã€‚

ãã®ã‚ˆã†ãªã¨ã“ã‚ã§ã¯å…¸å‹çš„ã«ã€å„ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã«ãŠã„ã¦producer-consumerãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ãŒè¡Œã‚ã‚Œã¾ã™ã€‚producerã¨consumerã®2ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€ãƒãƒªã‚¢ã®ãƒšã‚¢ã‚’ä½¿ç”¨ã—ã¦å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åŒæœŸã—ã¾ã™ã€‚

consumerã‚¹ãƒ¬ãƒƒãƒ‰ã¯consumerãƒãƒªã‚¢ã«ã‚ˆã£ã¦ãƒªã‚½ãƒ¼ã‚¹èª­ã¿å–ã‚Šã‚’å¾…æ©Ÿï¼ˆ`wait`ï¼‰ã—ã€ãƒãƒªã‚¢ãŒè§£é™¤ã•ã‚Œã‚‹ã¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã€ä½¿ç”¨çµ‚äº†ã™ã‚‹ã¨producerãƒãƒªã‚¢ã«åˆ°ç€ï¼ˆ`arrive`ï¼‰ã—ã¦å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã®å†åˆ©ç”¨ï¼ˆæ›´æ–°ï¼‰ãŒå®‰å…¨ã§ã‚ã‚‹ã“ã¨ã‚’producerã«é€šçŸ¥ã—ã¾ã™ã€‚

producerã‚¹ãƒ¬ãƒƒãƒ‰ã¯producerãƒãƒªã‚¢ã«ã‚ˆã£ã¦ãƒªã‚½ãƒ¼ã‚¹æ›´æ–°ã‚’å¾…æ©Ÿï¼ˆ`wait`ï¼‰ã—ã€ãƒãƒªã‚¢ãŒè§£é™¤ã•ã‚Œã‚‹ã¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã€æ›´æ–°çµ‚äº†ã™ã‚‹ã¨consumerãƒãƒªã‚¢ã«åˆ°ç€ï¼ˆ`arrive`ï¼‰ã—ã¦å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã®ä½¿ç”¨ï¼ˆèª­ã¿å–ã‚Šï¼‰ãŒå®‰å…¨ã§ã‚ã‚‹ã“ã¨ã‚’consumerã«é€šçŸ¥ã—ã¾ã™ã€‚

ã“ã®åŒæœŸãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ã€consumerã‚¹ãƒ¬ãƒƒãƒ‰ã¯consumerãƒãƒªã‚¢ã«åˆ°ç€ã™ã‚‹ã“ã¨ãªãå¾…æ©Ÿã—ã€producerãƒãƒªã‚¢ã«ã¯å¾…æ©Ÿã™ã‚‹ã“ã¨ãªãåˆ°ç€ã—ã¾ã™ï¼ˆproducerã‚¹ãƒ¬ãƒƒãƒ‰ã®å ´åˆã¯ã“ã®é€†ï¼‰ã€‚

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒãƒªã‚¢ã«`std::barrier`ã‚’ä½¿ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€`std::barrier`ã®åŒæœŸãŒãƒãƒªã‚¢ä¸Šã§å¾…æ©Ÿã™ã‚‹å‰ã«åˆ°ç€ã™ã‚‹ã“ã¨ã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã€åŒæœŸãŒéåŠ¹ç‡ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```cpp
#include <barrier>

// å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹
// 1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã„ã¾ã‚ã™
int shared_resource = 0;

// producerãƒãƒªã‚¢
// consumer -> producer ã¸ã®èª­ã¿è¾¼ã¿çµ‚äº†é€šçŸ¥
std::barrier producer_barrier{2};
// consumerãƒãƒªã‚¢
// producer -> consumer ã¸ã®æ›¸ãè¾¼ã¿çµ‚äº†é€šçŸ¥
std::barrier consumer_barrier{2};

// ãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
void produce(int&);
// ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã™ã‚‹é–¢æ•°
void consume(const int&);

// produceræœ¬ä½“
void producer() {
  // consumerãƒãƒªã‚¢ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’1ã«ã—ã¦ãŠãï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯å›é¿ã®ãŸã‚ï¼‰
  std::ignore = consumer_barrier.arrive();

  while(true) {
    // consumerã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿è¾¼ã¿çµ‚äº†ã‚’å¾…æ©Ÿ
    producer_barrier.arrive_and_wait();       // A
    // ãƒªã‚½ãƒ¼ã‚¹æ›´æ–°
    produce(shared_resource);
    // consumerã‚¹ãƒ¬ãƒƒãƒ‰ã¸æ›¸ãè¾¼ã¿çµ‚äº†ã‚’é€šçŸ¥
    std::ignore = consumer_barrier.arrive();  // B
  }
}

// consumeræœ¬ä½“
void consumer() {
  while(true) {
    // producerã‚¹ãƒ¬ãƒƒãƒ‰ã®æ›¸ãè¾¼ã¿çµ‚äº†ã‚’å¾…æ©Ÿ
    consumer_barrier.arrive_and_wait();       // A
    // ãƒªã‚½ãƒ¼ã‚¹åˆ©ç”¨
    consume(shared_resource);
    // producerã‚¹ãƒ¬ãƒƒãƒ‰ã¸èª­ã¿è¾¼ã¿çµ‚äº†ã‚’é€šçŸ¥
    std::ignore = producer_barrier.arrive();  // B
  }
}

int main() {
  std::jthread th{producer};
  consumer();
}
```

å•é¡ŒãŒã‚ã‚‹ã®ã¯ã‚µãƒ³ãƒ—ãƒ«ä¸­ã®`A`ã¨`B`ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã®ã¨ã“ã‚ã§ã™ã€‚`A`ã®ã¨ã“ã‚ã§ã¯åˆ°ç€ï¼ˆ`.arrive()`ï¼‰ã¯å¿…è¦ãªãå¾…æ©Ÿï¼ˆ`.wait()`ï¼‰ã ã‘ãŒå¿…è¦ã§ã‚ã‚Šã€`B`ã®ã¨ã“ã‚ã§ã¯`arrive()`ã«ã‚ˆã£ã¦ç™ºè¡Œã•ã‚Œã‚‹ãƒãƒªã‚¢ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸ç”¨ã§ã€`[[nodiscard]]`ã«ã‚ˆã‚‹è­¦å‘Šã‚’æ¶ˆã™ãŸã‚ã«ä½™è¨ˆãªã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã“ã®`A`ã§èµ·ã“ã‚‹ä¸è¦ãª`arrive()`ã¨`B`ã§èµ·ã“ã‚‹ä¸è¦ãªãƒãƒªã‚¢ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡ŒãŒã“ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¨ãªã‚Šã€ã—ã‹ã‚‚ç¾åœ¨ã®`std::barrier`ã®APIã§ã¯å›é¿ã§ãã¾ã›ã‚“ã€‚

ã“ã®ææ¡ˆã¯ã€ã“ã®å•é¡Œã®è§£æ±ºï¼ˆã“ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®åŠ¹ç‡å®Ÿè£…ï¼‰ã®ãŸã‚ã«ã€`std::barrier`ã«ã€Œåˆ°ç€ã—ãªã„å¾…æ©Ÿã€ã¨ã€Œå¾…æ©Ÿã—ãªã„åˆ°ç€ã€ã‚’è¡Œã†ãŸã‚ã®APIã‚’è¿½åŠ ã™ã‚‹ææ¡ˆã§ã™ã€‚ææ¡ˆã§ã¯ã€ã€Œåˆ°ç€ã—ãªã„å¾…æ©Ÿã€ã®ãŸã‚ã«`.wait_parity(bool)`ã€ã€Œå¾…æ©Ÿã—ãªã„åˆ°ç€ã€ã®ãŸã‚ã«`.arrive_and_discard()`ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’ç”¨ã„ã‚‹ã¨ä¸Šè¨˜ã®ã‚µãƒ³ãƒ—ãƒ«ã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™

```cpp
#include <barrier>

// å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹
// 1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã„ã¾ã‚ã™
int shared_resource = 0;

// producerãƒãƒªã‚¢
// consumer -> producer ã¸ã®èª­ã¿è¾¼ã¿çµ‚äº†é€šçŸ¥
// producerã‚¹ãƒ¬ãƒƒãƒ‰ã«ãŠã‘ã‚‹åˆ°ç€ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒç„¡ããªã‚Šã€åŒæœŸã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¯-1ã•ã‚Œã‚‹
std::barrier producer_barrier{1};
// consumerãƒãƒªã‚¢
// producer -> consumer ã¸ã®æ›¸ãè¾¼ã¿çµ‚äº†é€šçŸ¥
// consumerã‚¹ãƒ¬ãƒƒãƒ‰ã«ãŠã‘ã‚‹åˆ°ç€ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒç„¡ããªã‚Šã€åŒæœŸã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¯-1ã•ã‚Œã‚‹
std::barrier consumer_barrier{1};

// ãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
void produce(int&);
// ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã™ã‚‹é–¢æ•°
void consume(const int&);

// produceræœ¬ä½“
void producer() {
  // consumerãƒãƒªã‚¢ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«ã—ã¦ãŠãï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯å›é¿ã®ãŸã‚ï¼‰
  // ã“ã“ã§æœ€åˆã®ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã™ã‚‹ï¼ˆ0 -> 1ï¼‰
  consumer_barrier.arrive_and_discard();

  bool phase = false;
  while(true) {
    // consumerã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿è¾¼ã¿çµ‚äº†ã‚’å¾…æ©Ÿ
    producer_barrier.wait_parity(phase);    // A
    // ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã®æ›´æ–°
    phase = !phase;
    // ãƒªã‚½ãƒ¼ã‚¹æ›´æ–°
    produce(shared_resource);
    // consumerã‚¹ãƒ¬ãƒƒãƒ‰ã¸æ›¸ãè¾¼ã¿çµ‚äº†ã‚’é€šçŸ¥
    consumer_barrier.arrive_and_discard();  // B
  }
}

// consumeræœ¬ä½“
void consumer() {
  bool phase = false;
  while(true) {
    // producerã‚¹ãƒ¬ãƒƒãƒ‰ã®æ›¸ãè¾¼ã¿çµ‚äº†ã‚’å¾…æ©Ÿ
    // 1ç•ªæœ€åˆã¯ã€ãƒ•ã‚§ãƒ¼ã‚º1ã«å¯¾ã—ã¦ãƒ•ã‚§ãƒ¼ã‚º0ã§å¾…æ©Ÿã™ã‚‹ãŸã‚ã€ã™ããƒ–ãƒ­ãƒƒã‚¯è§£é™¤
    consumer_barrier.wait_parity(phase);    // A
    // ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã®æ›´æ–°
    phase = !phase;
    // ãƒªã‚½ãƒ¼ã‚¹åˆ©ç”¨
    consume(shared_resource);
    // producerã‚¹ãƒ¬ãƒƒãƒ‰ã¸èª­ã¿è¾¼ã¿çµ‚äº†ã‚’é€šçŸ¥
    producer_barrier.arrive_and_discard();  // B
  }
}

int main() {
  std::jthread th{producer};
  consumer();
}
```

`A`ã®ç‚¹ã§ã¯`.wait_parity()`ã«ã‚ˆã£ã¦ãƒãƒªã‚¢ã®ã‚«ã‚¦ãƒ³ãƒˆã«è§¦ã‚‹ã“ã¨ãªãå¾…æ©Ÿã—ã€`B`ã®ç‚¹ã§ã¯`.arrive_and_discard()`ã«ã‚ˆã£ã¦å¾…æ©Ÿã›ãšï¼ˆãƒãƒªã‚¢ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã›ãšï¼‰ã«åˆ°ç€ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ç¾åœ¨ã®APIã§ã¯å›é¿ã§ããªã‹ã£ãŸä¸è¦ãªåˆ°ç€ã¨å¾…æ©Ÿï¼ˆãƒãƒªã‚¢ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œï¼‰ã‚’å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã¦ãŠã‚Šã€ãªãŠã‹ã¤ãã‚Œã¯å®Ÿè£…ã«é€šçŸ¥ã•ã‚Œã‚‹ãŸã‚ã‚ˆã‚ŠåŠ¹ç‡çš„ãªåŒæœŸã¨ãªã‚‹ã“ã¨ãŒæœŸå¾…ã§ãã¾ã™ã€‚

ã¾ãŸã€ã“ã‚Œã«ã‚ˆã£ã¦ãã‚Œãã‚Œã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãŠã„ã¦ã®ä¸è¦ãªåˆ°ç€ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«æœ¬æ¥ä¸è¦ãªåŒæœŸæ•°ï¼ˆ`std::barrier`ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«æ¸¡ã—ã¦ã„ã‚‹å€¤ï¼‰ã®+1ãŒå¿…è¦ãªããªã£ã¦ã‚‚ã„ã¾ã™ï¼ˆã‚‚ã£ã¨ã‚‚ã€ã“ã‚Œã¯å®Ÿéš›ã®ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¨ä¸€è‡´ã™ã‚‹ä»¥å¤–ã®æ©æµã¯ãªã•ãã†ã§ã™ãŒï¼‰ã€‚

`.wait_parity()`ã«æ¸¡ã—ã¦ã„ã‚‹`bool`å€¤`phase`ã¯ã€ã‚ã‚‹é€£ç¶šã—ãŸ2å›ã®ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ`std::barrier`ã«ã‚ˆã‚‹1å›ã®åŒæœŸï¼‰ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã€`true/false`ã«ã‚ˆã£ã¦ç•°ãªã‚‹ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã«å¯¾ã™ã‚‹`.wait()`ã‚’è¡Œã†ã‚‚ã®ã§ã™ã€‚ã“ã‚Œã¯ã€`.wait_parity()`ã«ã‚ˆã‚‹å¾…æ©ŸãŒã©ã®ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã«å¯¾ã™ã‚‹ã‚‚ã®ãªã®ã‹ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

`std::barrier`ã«ã‚ˆã‚‹åŒæœŸã§ã¯ã€ã‚ã‚‹åŒæœŸãƒã‚¤ãƒ³ãƒˆï¼ˆ`.arrive_and_wait()`ï¼‰ã«æŒ‡å®šã—ãŸæ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåˆ°é”ã—ãŸå¾Œã€å®Œäº†é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰å†…éƒ¨ã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—å¾…æ©Ÿã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å†é–‹ã€ã¨ã„ã†æµã‚Œã‚’ç¹°ã‚Šè¿”ã™ã‚‚ã®ã§ã™ã€‚ã“ã®1ã¤ã®æµã‚Œï¼ˆåŒæœŸãƒã‚¤ãƒ³ãƒˆã‹ã‚‰åŒæœŸãƒã‚¤ãƒ³ãƒˆã®é–“ã®å‡¦ç†ï¼‰ã®ã“ã¨ã‚’ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã¨å‘¼ã³ã€`std::barrier`ã®ä¿è¨¼ã«ã‚ˆã£ã¦å„ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã¯æ™‚é–“æ–¹å‘ã«é †ç•ªã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚æœ€åˆã‚’0ã¨ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŒ¯ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãã®ã‚ˆã†ãªãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã¤ã„ã¦ã€`true`ã®å ´åˆã«å¥‡æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹`false`ã®å ´åˆã«å¶æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã—ã¦`bool`å€¤ã‚’å¯¾å¿œã¥ã‘ã¦ã€ã“ã®`bool`å€¤ã®ã“ã¨ã‚’ãƒ‘ãƒªãƒ†ã‚£ã¨å‘¼ã³ã¾ã™ã€‚

```
ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã®é€²è¡Œï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã¨ãƒ‘ãƒªãƒ†ã‚£ã®é–¢ä¿‚

phase  :   0   ->   1  ->   2   ->   3  ->   4   ->   5  -> ...
parity : false -> true -> false -> true -> false -> true -> ...
```

`.wait_parity()`ã«æ¸¡ã™`bool`å€¤ã¯ã€å¾…æ©Ÿå¯¾è±¡ã®ãƒ‘ãƒªãƒ†ã‚£ï¼ˆã™ãªã‚ã¡ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã§ã€æŒ‡å®šã—ãŸãƒ‘ãƒªãƒ†ã‚£ï¼ˆ`true/false`ï¼‰ã‹ã‚‰æ¬¡ã®ãƒ‘ãƒªãƒ†ã‚£ã¸å¤‰åŒ–ã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã‚’å¾…æ©Ÿã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`wait_parity(false)`ã¨ã—ãŸå ´åˆã¯å¶æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚ºã‚’å¾…æ©Ÿã—ã€å¾…æ©ŸãŒè§£é™¤ã•ã‚ŒãŸã‚‰å¥‡æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒãƒªã‚¢ãƒ•ã‚§ãƒ¼ã‚¹ãŒé–‹å§‹ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã—ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ‘ãƒªãƒ†ã‚£ã¨æŒ‡å®šã•ã‚ŒãŸãƒ‘ãƒªãƒ†ã‚£ãŒç•°ãªã‚‹å ´åˆã€ãã‚Œã¯1ã¤å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã«å¯¾ã™ã‚‹å¾…æ©Ÿã ã¨ã—ã¦å‡¦ç†ï¼ˆã™ãªã‚ã¡ã™ããƒ–ãƒ­ãƒƒã‚¯è§£é™¤ï¼‰ã•ã‚Œã¾ã™ã€‚

- [ã€C++ã€‘ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªå‡¦ç†ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŒ–ã—ã¦ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã‚’æ”¹å–„ã—ã¦ã¿ã‚‹ - ã‹ã¿ã®ãƒ¡ãƒ¢](https://kamino.hatenablog.com/entry/pipeline_cpp)
- [P2629 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1292)

### [P2630R0 Submdspan](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2630r0.html)

`std::mdspan`ã®éƒ¨åˆ†ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹é–¢æ•°`submdspan()`ã®ææ¡ˆã€‚

ã“ã®ææ¡ˆã¯ä»¥å‰ã¯`std::mdspan`ã®ææ¡ˆ(P0009)ã«å«ã¾ã‚Œã¦ã„ã¾ã—ãŸãŒã€`std::mdspan`ã‚’C++23ã«é–“ã«åˆã‚ã›ã‚‹ãŸã‚ã®æ™‚é–“ã®åˆ¶ç´„ã‹ã‚‰åˆ‡ã‚Šé›¢ã•ã‚Œã€å€‹åˆ¥ã®ææ¡ˆã¨ã—ã¦è­°è«–ã—ã¦ã„ãã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

`mdspan`ã¨ãã“ã§ã®`submdspan`ã«ã¤ã„ã¦ã¯ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P0009R12 MDSPAN - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´05æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/06/13/165215#P0009R12-MDSPAN)

`submdspan`ã«ã‚ˆã£ã¦`std::mdspan`ã‹ã‚‰éƒ¨åˆ†é ˜åŸŸã‚’ã‚¹ãƒ©ã‚¤ã‚¹ã¨ã—ã¦`std::mdspan`ã§å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã‚‹ã¨ã€`std::mdspan`ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«å®Ÿè£…ã•ã‚ŒãŸã‚ˆã‚Šå°ã•ã„å•é¡Œã‚’åŠ¹ç‡çš„ã«è§£æ±ºã™ã‚‹é–¢æ•°ã‚’å†åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆè¡Œåˆ—ç©ã«ãŠã‘ã‚‹ã€å„è¦ç´ ã”ã¨ã®å†…ç©è¨ˆç®—ãªã©ï¼‰ã€‚

ææ¡ˆæ–‡æ›¸ã‚ˆã‚Šã€é•·æ–¹ä½“å†…ã®3æ¬¡å…ƒæ ¼å­ã‚’è¡¨ã™`std::mdspan`ã‹ã‚‰

```cpp
// 2æ¬¡å…ƒé ˜åŸŸã‚’ã‚¼ãƒ­ã‚¯ãƒªã‚¢ã™ã‚‹
template<class T, class E, class L, class A>
void zero_2d(mdspan<T, E, L, A> grid2d) {
  // ãƒ©ãƒ³ã‚¯2ï¼ˆ2æ¬¡å…ƒï¼‰ã®mdspan
  static_assert(grid2d.rank() == 2);

  for(int i = 0; i < grid2d.extent(0); ++i) {
    for(int j = 0; j < grid2d.extent(1); ++j) {
      grid2d[i,j] = 0;
    }
  }
}

// é•·æ–¹ä½“è¡¨é¢ã‚’ã‚¼ãƒ­ã‚¯ãƒªã‚¢ã™ã‚‹
template<class T, class E, class L, class A>
void zero_surface(mdspan<T, E, L, A> grid3d) {
  // ãƒ©ãƒ³ã‚¯3ï¼ˆ3æ¬¡å…ƒï¼‰ã®mdspan
  static_assert(grid3d.rank() == 3);

  // 6ã¤ã®è¡¨é¢æ¯ã«ã€2æ¬¡å…ƒå¹³é¢ã‚’ã‚¼ãƒ­ã‚¯ãƒªã‚¢ã™ã‚‹zero_2d()ã‚’å†åˆ©ç”¨
  zero_2d(submdspan(grid3d, 0, full_extent, full_extent));
  zero_2d(submdspan(grid3d, full_extent, 0, full_extent));
  zero_2d(submdspan(grid3d, full_extent, full_extent, 0));
  zero_2d(submdspan(grid3d, grid3d.extent(0) - 1, full_extent, full_extent));
  zero_2d(submdspan(grid3d, full_extent, grid3d.extent(1) - 1, full_extent));
  zero_2d(submdspan(grid3d, full_extent, full_extent, grid3d.extent(2) - 1));
}
```

`submdspan()`ã¯`std`åå‰ç©ºé–“ã«å®šç¾©ã•ã‚Œã‚‹ãƒ•ãƒªãƒ¼é–¢æ•°ã§ã™ã€‚1ã¤ç›®ã®å¼•æ•°ã«`std::mdspan`ã‚’å–ã‚Šã€2ã¤ç›®ä»¥é™ã®å¼•æ•°ã§ã‚¹ãƒ©ã‚¤ã‚¹æŒ‡å®šã‚’æ¬¡å…ƒæ¯ã«å—ã‘å–ã‚Šã¾ã™ã€‚ã‚¹ãƒ©ã‚¤ã‚¹æŒ‡å®šã¯ã€1ã¤ç›®ã®å¼•æ•°ã‚’`x`ã€å¯¾å¿œã™ã‚‹æ¬¡å…ƒã®ç•ªå·ã‚’`d`ã¨ã—ã¦`[0, x.extent(d))`ã®ç¯„å›²ã®å€¤ã®ã©ã®è¦ç´ ãŒè¿”ã•ã‚Œã‚‹`std::mdspan`ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’æŒ‡å®šã—ã¾ã™ï¼ˆ`std::pair{4, 10}`ã®ã‚ˆã†ã«ã—ã¦ä»»æ„ã®ç¯„å›²ã‚’æŒ‡å®šã§ãã¾ã™ï¼‰ã€‚

ã“ã®ææ¡ˆã§ã¯P0009ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ãŸ`submdspan()`ã‚’å€‹åˆ¥ææ¡ˆã¨ã—ã¦å†æ§‹æˆã™ã‚‹ã¨ã¨ã‚‚ã«ã€æ¬¡ã®å¤‰æ›´ã‚’åŠ ãˆã¦ã„ã¾ã™

- ã‚¹ãƒ©ã‚¤ã‚¹æŒ‡å®šã¨ã—ã¦æŒ‡å®šå¯èƒ½ãªã‚‚ã®ã«`strided_index_range`å‹ã‚’è¿½åŠ 
  - ä»¥å‰ã¯ã€æ•´æ•°å€¤ï¼ˆå…ˆé ­ã‹ã‚‰ã®è¦ç´ æ•°ï¼‰ã€2è¦ç´ `tuple`-likeï¼ˆç¯„å›²æŒ‡å®šï¼‰ã€`full_extent_t`ï¼ˆå…¨ä½“ã®æŒ‡å®šï¼‰
  - `strided_index_range`ã¯ã€é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨é•·ã•ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ç¯„å›²æŒ‡å®šãŒã§ãã‚‹ã»ã‹ã€ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ï¼ˆè¦ç´ é–“éš”ï¼‰ã®æŒ‡å®šã‚‚å¯èƒ½
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨å¯èƒ½ãªã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 
  - å…¥åŠ›`mdspan<T, E, L, A>`ã®`L`ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚¯ãƒ©ã‚¹ï¼‰ã‚’ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ãŸã‚ã«`submdspan_mapping()`ã¨`submdspan_offset()`ã‚’è¿½åŠ 
  - `submdspan()`å†…éƒ¨ã§ã¯ã“ã®2ã¤ã®é–¢æ•°ã‚’`L`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨ã„ãŸADLã«ã‚ˆã£ã¦å‘¼ã¶ã“ã¨ã§ã€ã“ã®2ã¤ã®é–¢æ•°ã‚’`L`æ¯ã«ã‚«ã‚¹ã‚¿ãƒ å¯èƒ½ã«ã™ã‚‹
  - ã“ã‚Œã‚‰ã®çµæœã‚’ç”¨ã„ã¦ã€è¿”ã™`mdspan`ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒªã‚·ãƒ¼ã¨ã‚¢ã‚¯ã‚»ã‚µã€ãƒ‡ãƒ¼ã‚¿ãƒãƒ³ãƒ‰ãƒ«ï¼ˆé ˜åŸŸã‚’å‚ç…§ã™ã‚‹æ–¹æ³•ã€é€šå¸¸ã¯ãƒã‚¤ãƒ³ã‚¿ï¼‰ã‚’å–å¾—ã™ã‚‹
- ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å€¤ã¨ã—ã¦æŒ‡å®šã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ 
  - ã‚¹ãƒ©ã‚¤ã‚¹æŒ‡å®šãŒå®šæ•°å€¤ã§æŒ‡å®šã•ã‚ŒãŸã¨ãã«ã€ãã‚Œã‚’è¿”ã™`mdspan`ã®ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸ‹ã‚è¾¼ã‚€

`submdspan()`ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```cpp
template<class T, class E, class L, class A,
         class ... SliceArgs>
constexpr auto submdspan(const mdspan<T, E, L, A>& src, SliceArgs... args) {
  // éƒ¨åˆ†mdspanã®ã‚ªãƒ•ã‚»ãƒƒãƒˆå–å¾—
  size_t sub_offset = submdspan_offset(src.mapping(), args...); // ADLã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ
  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã®å–å¾—
  auto sub_map = submdspan_mapping(src.mapping(), args...);     // ADLã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ
  // ã‚¢ã‚¯ã‚»ã‚µã®å–å¾—
  typename A::offset_policy sub_acc(src.accessor());  // A::offset_policyå…¥ã‚Œå­å‹ã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ
  // ãƒ‡ãƒ¼ã‚¿ãƒãƒ³ãƒ‰ãƒ«ã®å–å¾—
  typename A::offset_policy::data_handle_type         // A::offset_policy::data_handle_typeå…¥ã‚Œå­å‹ã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ
    sub_handle = src.accessor().offset(src.data_handle(), sub_offset);

  return mdspan(sub_handle, sub_map, sub_acc);
}
```

ã“ã®ææ¡ˆã¯ã‚ã–ã‚ã–P0009ã‹ã‚‰åˆ†é›¢ã—ãŸã“ã¨ã‚‚ã‚ã‚Šã€ãŠãã‚‰ãC++23ã«ã¯é–“ã«åˆã‚ãªã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚

- [P2630 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1293)

### [P2633R0 `thread_local_inherit`: Enhancing thread-local storage](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2633r0.html)

å‘¼ã³å‡ºã—å…ƒã§ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å€¤ã‚’å¼•ãç¶™ã„ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã€`thread_local_inherit`æŒ‡å®šã®ææ¡ˆã€‚

ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆæ™‚ã«å‘¼ã³å‡ºã—å…ƒã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®å¯¾å¿œã™ã‚‹å¤‰æ•°ãŒæŒã£ã¦ã„ã‚‹å€¤ã¨ã¯ç„¡é–¢ä¿‚ã«åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€å‘¼ã³å‡ºã—å…ƒã‚¹ãƒ¬ãƒƒãƒ‰ã®å¯¾å¿œã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å€¤ã‚’å¼•ãç¶™ãã¤ã¤ã€å¾Œã‹ã‚‰ãã®å€¤ã‚’æ›´æ–°ã—ãŸã„å ´åˆãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚ãã®ã‚ˆã†ãªå¤‰æ•°ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã™ã‚‹é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã‚¹ãƒ¬ãƒƒãƒ‰èµ·å‹•æ™‚ç‚¹ã§ã¯ãã®å¤‰æ•°ã‚’ç”¨æ„ã§ããªã„å ´åˆãŒã‚ã‚‹ã»ã‹ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èµ·å‹•ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰ãŒå‘¼ã³å‡ºã™ã‚¹ãƒ¬ãƒƒãƒ‰ã«é–¢ã—ã¦ã®æƒ…å ±ã‚’æŒã£ã¦ã„ãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ä»–ã®æ–¹æ³•ã¯é¢å€’ã§ã‚ã‚Šã€ã‚¹ãƒ¬ãƒƒãƒ‰èµ·å‹•å´/ã‚¹ãƒ¬ãƒƒãƒ‰å†…å‡¦ç†å´ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒãŒãã‚Œãã‚Œã©ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã‹ã‚’çŸ¥ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å‘¼ã³å‡ºã•ã‚ŒãŸã‚¹ãƒ¬ãƒƒãƒ‰ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å¿…è¦ãªæ™‚ç‚¹ã§å¿…è¦ãªå ´æ‰€ã«è‡ªå‹•çš„ã«ä¾›çµ¦å¯èƒ½ãªè¨€èªæ©Ÿèƒ½ã«ã¯ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã€ãã‚Œã‚’å®Ÿç¾å¯èƒ½ãª`thread_local_inherit`ã¨ã„ã†æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æŒ‡å®šã‚’å°å…¥ã—ã‚ˆã†ã¨ã™ã‚‹ææ¡ˆã§ã™ã€‚

`thread_local_inherit`å¤‰æ•°ã¯ã€åˆæœŸåŒ–å‘¨ã‚Šã®ã“ã¨ã¨*trivially copyable*ãªå‹ã«ã—ã‹æŒ‡å®šã§ããªã„ã“ã¨ä»¥å¤–ã¯`thread_local`å¤‰æ•°ã¨åŒã˜æ€§è³ªã‚’æŒã¡ã¾ã™ã€‚

ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãŠã‘ã‚‹`thread_local_inherit`å¤‰æ•°ã¯`thread_local`å¤‰æ•°ã¨åŒæ§˜ã«åˆæœŸåŒ–ã•ã‚Œã€å­ã‚¹ãƒ¬ãƒƒãƒ‰ã®`thread_local_inherit`å¤‰æ•°ã¯å‘¼ã³å‡ºã—å…ƒã‚¹ãƒ¬ãƒƒãƒ‰ã®å¤‰æ•°ã®å€¤ã‚’å˜ç´”ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦é™çš„åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚`thread_local_inherit`å¤‰æ•°ã«å¯¾ã™ã‚‹å‹•çš„åˆæœŸåŒ–ã¯ãã®å¤‰æ•°ãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã«ã®ã¿èµ·ã“ã‚Šã€ã“ã‚Œã¯ãŠãã‚‰ããƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã®æœ€åˆã®åˆæœŸåŒ–æ™‚ã«ã®ã¿èµ·ã“ã‚Šã¾ã™ã€‚

```cpp
#include <future>
#include <iostream>

thread_local int th1 = 0;
thread_local_inherit int th2 = 0;

void f() {
  std::cout << "thread_local : " << th1 << "\n";
  std::cout << "thread_local_inherit : " << th2 << "\n";
}

int main() {
  std::ignore = std::async(f);
  th1 = 1;
  th2 = 1;
  std::ignore = std::async(f);
  th1 = 2;
  th2 = 2;
  std::ignore = std::async(f);
}
```
```
thread_local : 0
thread_local_inherit : 0
thread_local : 0
thread_local_inherit : 1
thread_local : 0
thread_local_inherit : 2
```

- [P2633 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1294)

### [P2634R0 Allow qualifiers in constructor declarations](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2634r0.html)

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ã€`const/volatile`ãŠã‚ˆã³å‚ç…§ä¿®é£¾ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ææ¡ˆã€‚

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ`const`ã§æ§‹ç¯‰ã•ã‚Œã‚‹æ™‚ã¨ãã†ã§ãªã„æ™‚ã€ã‚ã‚‹ã„ã¯å·¦è¾ºå€¤ã§æ§‹ç¯‰ã•ã‚Œã‚‹æ™‚ã¨å³è¾ºå€¤ã§æ§‹ç¯‰ã•ã‚Œã‚‹æ™‚ã€ã“ã‚Œã‚‰ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã™ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’åˆ†ã‘ã‚‹ã¨ä¾¿åˆ©ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ¡ãƒ³ãƒé–¢æ•°ã§ã¯ã€CV/å‚ç…§ä¿®é£¾ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹æ¯ã«å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ã¯ãã‚Œã‚‰ã®ä¿®é£¾ãŒè¡Œãˆãªã„ãŸã‚ã€ç¾åœ¨ã¯ã“ã®ã‚ˆã†ãªã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ã“ã®ææ¡ˆã¯ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«CV/å‚ç…§ä¿®é£¾ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’æ§‹ç¯‰ã®ã•ã‚Œæ–¹ã«ã‚ˆã£ã¦å‘¼ã³åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

```cpp
struct S {
  S() &;        // #1ã€å·¦è¾ºå€¤ã¨ã—ã¦æ§‹ç¯‰ã™ã‚‹éš›ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
  S() &&;       // #2ã€å³è¾ºåœ°ã¨ã—ã¦æ§‹ç¯‰ã™ã‚‹éš›ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
  S() const &;  // #3ã€constå·¦è¾ºå€¤ã¨ã—ã¦æ§‹ç¯‰ã™ã‚‹éš›ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
};

S x;          // #1ãŒå‘¼ã°ã‚Œã‚‹
S();          // #2ãŒå‘¼ã°ã‚Œã‚‹
const S y;    // #3ãŒå‘¼ã°ã‚Œã‚‹
new const S;  // #3ãŒå‘¼ã°ã‚Œã‚‹
```

ã“ã‚Œã¯ä¾‹ãˆã°ã€`delete`ã¨å…±ã«ä½¿ç”¨ã—ã¦å³è¾ºå€¤ã¨ã—ã¦ã®æ§‹ç¯‰ã‚’ç¦æ­¢ã—ãŸã‚Šã€`const`ã¨ã—ã¦æ§‹ç¯‰ã•ã‚ŒãŸæ™‚ã«ã ã‘ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å‡¦ç†ã‚’å˜ç´”åŒ–ã™ã‚‹ã€ãªã©ã®ç”¨æ³•ãŒã‚ã‚Šãã†ã§ã™ã€‚

- [P2634 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1295)

### [P2635R0 Enhancing the break statement](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2635r0.html)

`break`æ–‡ã‚’æ‹¡å¼µã—ã¦ã€ãƒã‚¹ãƒˆã—ãŸãƒ«ãƒ¼ãƒ—ã«ãŠã‘ã‚‹åˆ©ä¾¿æ€§ã‚’æ”¹å–„ã™ã‚‹ææ¡ˆã€‚

ãƒã‚¹ãƒˆã—ãŸãƒ«ãƒ¼ãƒ—ã«ãŠã„ã¦å†…å´ã®ãƒ«ãƒ¼ãƒ—ã‚’`break`ã§çµ‚äº†ã•ã›ã‚‹æ™‚ã€çµ‚äº†ç›´å¾Œã«ä½•ã‹ã—ãŸã„ï¼ˆç‰¹ã«ã€å¤–å´ã®ãƒ«ãƒ¼ãƒ—ã®ç¶™ç¶šã«é–¢ã—ã¦ï¼‰å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå ´åˆã€å…¸å‹çš„ã«ã¯ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ã‹`goto`ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```cpp
void before1(std::ranges::range auto&& range_i) {
  for (auto&& range_j : range_i) {
    bool broke = false;

    for (auto j : range_j) {
      if (cond(j)) {
        // ãƒ«ãƒ¼ãƒ—ã‚’ç¶™ç¶šã™ã‚‹å‡¦ç†
        ...
      } else {
        // ãƒ«ãƒ¼ãƒ—ã‚’ä¸­æ–­ã™ã‚‹
        broke = true;
        break;
      }
    }
    
    if (broke) {
      continue;
    } else {
      // å†…å´ãƒ«ãƒ¼ãƒ—ãŒå®Œäº†ã—ãŸå¾Œã®å‡¦ç†
      ...
    }
  }
}

void before2(std::ranges::range auto&& range_i) {
  for (auto&& range_j : range_i) {
    for (auto j : range_j) {
      if (cond(j)) {
        // ãƒ«ãƒ¼ãƒ—ã‚’ç¶™ç¶šã™ã‚‹å‡¦ç†
        ...
      } else {
        // ãƒ«ãƒ¼ãƒ—ã‚’ä¸­æ–­ã™ã‚‹
        goto broke;
      }
    }
    
    // å†…å´ãƒ«ãƒ¼ãƒ—ãŒå®Œäº†ã—ãŸå¾Œã®å‡¦ç†
    ...

    // å†…å´ãƒ«ãƒ¼ãƒ—ã®ä¸­æ–­å…ˆ
    broke: ;
  }
}
```

ä»–ã«ã‚‚é–¢æ•°ã«ã™ã‚‹ã¨ã‹ãƒ©ãƒ ãƒ€å¼ã‚’ä½¿ã†ã¨ã‹ã‚ã‚Šã¾ã™ãŒã€ã„ãšã‚Œã«ã›ã‚ˆã“ã®ã‚ˆã†ãªå ´åˆã«`break`ã®åŠ¹æœã¯ä¸ååˆ†ã§ã—ãŸã€‚

ã“ã®ææ¡ˆã¯ã€`break`ã‚’æ‹¡å¼µã—ã¦ã“ã®ã‚ˆã†ãªå ´åˆã«ä½™åˆ†ãªã‚³ãƒ¼ãƒ‰ã‚’æœ€å°ã«ã—ã¤ã¤åŒã˜ã“ã¨ã‚’é”æˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

ææ¡ˆã§ã¯ã€`break statement;`ã¨ã„ã†æ§‹æ–‡ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«ã—ã€`break`ç›´å¾Œã«`statement`ã‚’å®Ÿè¡Œã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```cpp
void after(std::ranges::range auto&& range_i) {
  for (auto&& range_j : range_i) {
    for (auto j : range_j) {
      if (cond(j)) {
        // ãƒ«ãƒ¼ãƒ—ã‚’ç¶™ç¶šã™ã‚‹å‡¦ç†
        ...
      } else {
        // ãƒ«ãƒ¼ãƒ—ã‚’ä¸­æ–­ã—ã€å¤–å´ãƒ«ãƒ¼ãƒ—ã§ã¯continueã™ã‚‹
        break continue;
      }
    }

    // å†…å´ãƒ«ãƒ¼ãƒ—ãŒå®Œäº†ã—ãŸå¾Œã®å‡¦ç†
    ...
  }
}
```

`break statement;`ã®`statement`ã«ã¯`return`ã¨ã‹`break`ãã®ã‚‚ã®ã‚‚ãŠãäº‹ãŒã§ãã§ã€å¤šé‡ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®è„±å‡ºã«ã¯`break break ...;`ã¨æ›¸ãäº‹ãŒã§ãã¾ã™

```cpp
void after(std::ranges::range auto&& range_i) {
  for (auto&& range_j : range_i) {
    for (auto j : range_j) {
      if (cond(j)) {
        // æ¡ä»¶ã‚’æº€ãŸã—ãŸã‚‰2é‡ãƒ«ãƒ¼ãƒ—ã‹ã‚‰è„±å‡º
        break break;
      }
    }
  }
}
```

- [P2635 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1296)
