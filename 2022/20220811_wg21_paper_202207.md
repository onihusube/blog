# ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´07æœˆï¼‰

æ–‡æ›¸ã®ä¸€è¦§

- [JTC1/SC22/WG21 - Papers 2022 mailing2022-07](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/#mailing2022-07)

å…¨éƒ¨ã§47æœ¬ã‚ã‚Šã¾ã™ã€‚

[:contents]

### [P0009R18 MDSPAN](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p0009r18.html)

å¤šæ¬¡å…ƒé…åˆ—ã«å¯¾ã™ã‚‹`std::span`ã§ã‚ã‚‹ã€`mdspan`ã®ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P0009R12 MDSPAN - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´05æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/06/13/165215#P0009R12-MDSPAN)
- [P0009R13 MDSPAN - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´10æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/11/13/193322#P0009R13-MDSPAN)
- [P0009R14 MDSPAN - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´11æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/12/11/220126#P0009R14-MDSPAN)
- [P0009R15 MDSPAN - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´02æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/03/19/224729#P0009R15-MDSPAN)
- [P0009R16 MDSPAN - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´03æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/04/02/175835#P0009R16-MDSPAN)
- [P0009R17 MDSPAN - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´07æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/07/09/160343#P0009R17-MDSPAN)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€LWGã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ã¦ã®æ–‡è¨€èª¿æ•´ã®ã¿ã§ã™ã€‚

ã“ã®ææ¡ˆã¯ä»Šå›ï¼ˆ2022/07ï¼‰ã®å…¨ä½“ä¼šè­°ã§æ‰¿èªã•ã‚Œã€C++23å…¥ã‚Šã—ã¦ã„ã¾ã™ã€‚

- [P0009 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/96)

### [P1018R17 C++ Language Evolution status ğŸ¦  pandemic edition ğŸ¦  2022/06â€“2022/07](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1018r17.html)

2022å¹´6æœˆã‹ã‚‰7æœˆã«ã‹ã‘ã¦ã®EWGæ´»å‹•å ±å‘Šæ›¸ã€‚

æŠ•ç¥¨ã«ã‹ã‘ã‚‰ã‚ŒãŸææ¡ˆã¯ä»¥ä¸‹ã®ã‚‚ã®ã§ã™

- [P2513R2 char8_t Compatibility and Portability Fixes](https://wg21.link/P2513R2)
- [P1854R3 Conversion to literal encoding should not lead to loss of meaning](https://wg21.link/P1854R3)

ãã®ã»ã‹ã«ã‚‚ã€ã„ãã¤ã‹ã®ã‚³ã‚¢è¨€èªIssueãŒCWGã«è»¢é€ã•ã‚Œã¦ã„ã¾ã™ã€‚

### [P1083R6 Move `resource_adaptor` from Library TS to the C++ WP](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1083r6.pdf)

`pmr::resource_adaptor`ã‚’Library Foundermental TSã‹ã‚‰ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‰ãƒ©ãƒ•ãƒˆã¸ç§»å‹•ã™ã‚‹ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P1083R4 Move `resource_adaptor` from Library TS to the C++ WP - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´01æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/02/19/181101#P1083R4-Move-resource_adaptor-from-Library-TS-to-the-C-WP)
- [P1083R5 Move `resource_adaptor` from Library TS to the C++ WP - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´03æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/04/02/175835#P1083R5-Move-resource_adaptor-from-Library-TS-to-the-C-WP)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯

- `max_align_v`ï¼ˆæœ€å¤§ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è¡¨ã™å®šæ•°ï¼‰ã‚’`inline constexpr`å¤‰æ•°ã¨ã—ã¦å®šç¾©
- `aligned_raw_storage`ã®å…¥ã‚Œå­å‹`::type`ã‚’å‰Šé™¤
- `aligned_raw_storage`ã¯`std::aligned_storage`ã®å®Œå…¨ãªä»£æ›¿ã§ã¯ãªã„ã“ã¨ã‚’æ˜ç¢ºåŒ–
- ã“ã®ææ¡ˆã«ã¯å¿…é ˆã§ã¯ãªã‹ã£ãŸãŸã‚ã€`aligned_object_storage`ã‚’å‰Šé™¤
- C++26ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸å¤‰æ›´

ãªã©ã§ã™ã€‚

- [P1083 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/33)

### [P1255R8 A view of 0 or 1 elements: views::maybe](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1255r8.pdf)

`std::optional`ã‚„ãƒã‚¤ãƒ³ã‚¿ç­‰ã®maybeãƒ¢ãƒŠãƒ‰ãªå¯¾è±¡ã‚’ã€ãã®çŠ¶æ…‹ã«ã‚ˆã£ã¦è¦ç´ æ•°0ã‹1ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«å¤‰æ›ã™ã‚‹Rangeã‚¢ãƒ€ãƒ—ã‚¿`views::maybe`ã®ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P1255R6 : A view of 0 or 1 elements: `views::maybe` - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´04æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/05/01/194425#P1255R6--A-view-of-0-or-1-elements-viewsmaybe)
- [P1255R7 : A view of 0 or 1 elements: `views::maybe` - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´05æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/06/11/191943#P1255R7-A-view-of-0-or-1-elements-viewsmaybe)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã‚¿ã‚¤ãƒä¿®æ­£ã‚„è¦‹ãŸç›®ã®èª¿æ•´ã®ã¿ã§ã™ã€‚

- [P1255 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/60)

### [P1642R11 Freestanding Library: Easy [utilities], [ranges], and [iterators]](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1642r11.html)

[[utility]](https://timsong-cpp.github.io/cppwp/n4861/#utilities)ã€`<ranges>`ã€`<iterator>`ã‹ã‚‰ä¸€éƒ¨ã®ã‚‚ã®ã‚’ãƒ•ãƒªãƒ¼ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿½åŠ ã™ã‚‹ææ¡ˆã€‚

å‰å›ã®è¨˜äº‹ã‚’å‚ç…§

- [P1642R3 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´6æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/07/05/003248#P1642R3--Freestanding-Library-Easy-utilities-ranges-and-iterators)
- [P1642R4 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´7æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/08/12/014639#P1642R4--Freestanding-Library-Easy-utilities-ranges-and-iterators)
- [P1642R5 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´12æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/01/17/005823#P1642R5-Freestanding-Library-Easy-utilities-ranges-and-iterators)
- [P1642R6 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´06æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/07/12/182757#P1642R6-Freestanding-Library-Easy-utilities-ranges-and-iterators)
- [P1642R7 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´10æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/11/13/193322#P1642R7-Freestanding-Library-Easy-utilities-ranges-and-iterators)
- [P1642R8 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´04æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/05/08/195618#P1642R8-Freestanding-Library-Easy-utilities-ranges-and-iterators)
- [P1642R9 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´05æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/06/11/191943#P1642R9-Freestanding-Library-Easy-utilities-ranges-and-iterators)
- [P1642R10 Freestanding Library: Easy [utilities], [ranges], and [iterators] - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´06æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/07/09/160343#P1642R10-Freestanding-Library-Easy-utilities-ranges-and-iterators)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€ææ¡ˆã™ã‚‹æ–‡è¨€ã®èª¿æ•´ã®ã¿ã§ã™ã€‚

ã“ã®ææ¡ˆã¯ä»Šå›ï¼ˆ2022/07ï¼‰ã®å…¨ä½“ä¼šè­°ã§æ‰¿èªã•ã‚Œã€C++23å…¥ã‚Šã—ã¦ã„ã¾ã™ã€‚

- [P1642 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/429)


### [P1684R3 `mdarray`: An Owning Multidimensional Array Analog of mdspan](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1684r3.html)

å¤šæ¬¡å…ƒé…åˆ—ã‚¯ãƒ©ã‚¹`mdarray`ã®ææ¡ˆã€‚

- [P1684R1 mdarray: An Owning Multidimensional Array Analog of mdspan - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´03æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/04/02/175835#P1684R1-mdarray-An-Owning-Multidimensional-Array-Analog-of-mdspan)
- [P1684R2   mdarray: An Owning Multidimensional Array Analog of mdspan - ï¼»C++ï¼½WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´04æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/05/08/195618#P1684R2-mdarray-An-Owning-Multidimensional-Array-Analog-of-mdspan)

ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯

- `std::mdspan`ã«é©ç”¨ã•ã‚ŒãŸææ¡ˆã‚’ã“ã¡ã‚‰ã«ã‚‚é©ç”¨ã—ãŸ
    - [P2554](https://wg21.link/P2554), [P2553](https://wg21.link/P2553), [P2599](https://wg21.link/P2599), [P2406](https://wg21.link/P2406)
- *size constructible container*ã¨ã„ã†è¦ä»¶ã‚’æ–°è¨­
    - æ•´æ•°ï¼ˆã‚‚ã—ãã¯`range/initilizer_list`ï¼‰ã‹ã‚‰ã®æ§‹ç¯‰ã«ã‚ˆã£ã¦ã€æ§‹ç¯‰å¾Œã®ã‚µã‚¤ã‚ºã‚’æŒ‡å®šã§ãã‚‹ã‚³ãƒ³ãƒ†ãƒŠ
- `std::mdspan`ã‹ã‚‰ã®æ§‹ç¯‰ã®ãŸã‚ã®æ¨è«–è£œåŠ©ã‚’è¿½åŠ 
- `range/initilizer_list`ã‹ã‚‰ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‰Šé™¤
- æ–‡è¨€ã®è§£èª¬ã‚’æ›´æ–°

ãªã©ã§ã™ã€‚

- [P1684 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/461)

### [P1899R3 stride_view](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1899r3.html)
### [P1967R8 #embed - a simple, scannable preprocessor-based resource acquisition method](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p1967r8.html)
### [P2047R3 An allocator-aware optional type](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2047r3.html)
### [P2079R3 System execution context](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2079r3.html)
### [P2165R4 Compatibility between tuple, pair and tuple-like objects](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2165r4.pdf)
### [P2248R5 Enabling list-initialization for algorithms](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2248r5.html)
### [P2295R6 Support for UTF-8 as a portable source file encoding](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2295r6.pdf)
### [P2361R5 Unevaluated strings](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2361r5.pdf)
### [P2374R4 views::cartesian_product](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2374r4.html)
### [P2404R3 Move-only types for equality_comparable_with, totally_ordered_with, and three_way_comparable_with](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2404r3.pdf)
### [P2417R2 A more constexpr bitset](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2417r2.pdf)
### [P2419R2 Clarify handling of encodings in localized formatting of chrono types](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2419r2.html)
### [P2460R2 Relax requirements on wchar_t to match existing practices](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2460r2.pdf)
### [P2474R2 views::repeat](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2474r2.html)
### [P2481R1 Forwarding reference to specific type/template](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2481r1.html)
### [P2494R2 Relaxing range adaptors to allow for move only types](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2494r2.html)
### [P2513R4 char8_t Compatibility and Portability Fix](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2513r4.html)
### [P2547R1 Language support for customisable functions](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2547r1.html)
### [P2548R0 `copyable_function`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2548r0.pdf)

`std::move_only_function`ã«å¯¾ã—ã¦ã€ã‚³ãƒ”ãƒ¼å¯èƒ½ãª*Callable*ãƒ©ãƒƒãƒ‘ã§ã‚ã‚‹`copyable_function`ã®ææ¡ˆã€‚

C++23ã§å°å…¥ã•ã‚ŒãŸ`std::move_only_function`ã¯ã€ãã®é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã«`const`/å‚ç…§ä¿®é£¾ã¨`noexcept`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã€å‘¼ã³å‡ºã—æ™‚ã«è‡ªä¿¡ã®`const`æ€§ã¨å€¤ã‚«ãƒ†ã‚´ãƒªã‚’ä¿æŒã™ã‚‹*Callable*ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ã§ä¼æ’­ã•ã›ãŸã†ãˆã§å‘¼ã³å‡ºã—ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€`std::move_only_function`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`const`æœ‰ç„¡ã¨å³è¾ºå€¤ã§ã‚ã‚‹ã‹ã®çŠ¶æ…‹ã¨ã€ä¿æŒã™ã‚‹*Callbale*ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‘¼ã³å‡ºã—ç’°å¢ƒã‚’ä¸€è‡´ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸€æ–¹`std::function`ã«ã¯ãã®ã‚ˆã†ãªã‚µãƒãƒ¼ãƒˆã¯ãªãã€ãã®ãŸã‚ã«`const`ä¿®é£¾ã®ãƒŸã‚¹ãƒãƒƒãƒãƒã‚°ç­‰ã®è¨­è¨ˆä¸Šã®å•é¡ŒãŒã„ãã¤ã‹æŒ‡æ‘˜ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

- `const`ä¿®é£¾ã‚’æ­£ã—ãæ‰±ãˆãªã„
- ãƒ ãƒ¼ãƒ–ã®ã¿å¯èƒ½ãªï¼ˆã‚³ãƒ”ãƒ¼ã§ããªã„ï¼‰*Callable*ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒã§ããªã„
- å·¦è¾ºå€¤ã‹ã‚‰å‘¼ã³å‡ºã™*Callable*ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã—ã‹ä¿æŒã§ããªã„ï¼ˆå‚ç…§ä¿®é£¾ã‚’æ­£ã—ãæ‰±ãˆãªã„ï¼‰

`std::move_only_function`ã¯`std::fucntion`ã®æŒã¤ã“ã‚Œã‚‰ã®å•é¡Œã¨è»½å¾®ãªã„ãã¤ã‹ã®å•é¡Œï¼ˆRTTIã¸ã®ä¾å­˜ã€å‘¼ã³å‡ºã—æ™‚ã®ç©ºãƒã‚§ãƒƒã‚¯ï¼‰ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«å°å…¥ã•ã‚Œã¾ã—ãŸãŒã€åå‰ãŒç¤ºã™ã¨ãŠã‚Šã«`std::move_only_function`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ ãƒ¼ãƒ–ã—ã‹ã§ãã¾ã›ã‚“ï¼ˆãƒ ãƒ¼ãƒ–ã—ã‹ã§ããªã„*Callable*ã ã‘ã‚’ä¿æŒå¯èƒ½ãªã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚

ã‚³ãƒ”ãƒ¼å¯èƒ½ãª`std::move_only_function`ãŒæ¬²ã—ã„å ´åˆã¯`std::function`ã‚’ä½¿ç”¨ã™ã‚‹ã—ã‹ãªã„ã®ã§ã™ãŒã€`std::function`ã«ã¯ä¸Šè¨˜ã®ã‚ˆã†ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€å¾Œæ–¹äº’æ›ã®ãŸã‚ã«ã¯ã€`std::function`ã‚’`std::move_only_function`ã®ã‚ˆã†ãªè¨­è¨ˆã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚

ã“ã®ææ¡ˆã¯ã€ã‚³ãƒ”ãƒ¼å¯èƒ½ã‹ã¤ç¾åœ¨ã®`std::function`ã®å•é¡Œã‚’è§£æ±ºã—ãŸã€`std::move_only_function`ã®ã‚³ãƒ”ãƒ¼å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹`std::copyable_function`ã‚’æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿½åŠ ã™ã‚‹ææ¡ˆã§ã™ã€‚

`std::move_only_function`ãŒä¿æŒã™ã‚‹*Callable*ã¯`copyable`ã§ã‚ã£ã¦ã‚‚å˜ã«`movable`ã§ã—ã‹ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ãŒã€`std::copyable_function`ã¯`copyable`ãª*Callable*ã—ã‹ä¿æŒã§ãã¾ã›ã‚“ã€‚ãã‚Œä»¥å¤–ã®ã¨ã“ã‚ã§ã¯ã€`std::move_only_function`ã«ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ã‚³ãƒ”ãƒ¼ä»£å…¥æ¼”ç®—å­ã‚’è¿½åŠ ã—ãŸã ã‘ã§ã™ã€‚

<table>
<tr>
<th>ç¾åœ¨</th>
<th>ã“ã®ææ¡ˆ</th>
</tr>
<tr>
<td valign="top">

```cpp
auto lambda{[&]() /*const*/ { â€¦ }};

function<void(void)> func{lambda};  // âœ”
const auto & ref{func};

func(); // âœ”
ref();  // âœ”
```

</td>
<td valign="top">

```cpp
auto lambda{[&]() /*const*/ { â€¦ }};

copyable_function<void(void)> func0{lambda};    // âœ”
const auto & ref0{func0};

func0();  // âœ”
ref0();   // âŒ operator() is NOT const! 

copyable_function<void(void) const> func1{lambda};  // âœ”
const auto & ref1{func1};

func1();  // âœ”
ref1();   // âœ” operator() is const! 
```

</pre>
</td>
</tr>
</table>

<table>
<tr>
<th>ç¾åœ¨</th>
<th>ã“ã®ææ¡ˆ</th>
</tr>
<tr>
<td valign="top">

```cpp
auto lambda{[&]() mutable { â€¦ }};

function<void(void)> func{lambda};  // âœ”
const auto & ref{func};

func(); // âœ”
ref();  // â‰âœ” operator() is const! 
        //     this is the infamous constness-bug
```

</td>
<td valign="top">

```cpp
auto lambda{[&]() mutable { â€¦ }};

copyable_function<void(void)> func{lambda}; // âœ”
const auto & ref{func};

func(); // âœ”
ref();  // âŒ operator() is NOT const! 

copyable_function<void(void) const> tmp{lambda};  // âŒ
```

</pre>
</td>
</tr>
</table>

- [N4159 `std::functionand` Beyond](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4159.pdf)
- [MFHava/P2548 - Github](https://github.com/MFHava/P2548)
- [P2548 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1275)

### [P2549R1 std::unexpected should have error() as member accessor](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2549r1.html)
### [P2561R0 `operator??`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2561r0.html)

`std::expected`ãªã©ã‚’è¿”ã™é–¢æ•°ã«ãŠã„ã¦ã€ã‚¨ãƒ©ãƒ¼ã®ä¼æ’­ã‚’è‡ªå‹•åŒ–ã•ã›ã‚‹æ¼”ç®—å­`??`ã®ææ¡ˆã€‚

ä¾‹å¤–ã‚’æŠ•ã’ã†ã‚‹é–¢æ•°ã‚’æ‰±ã†é–¢æ•°ãŒè‡ªèº«ã‚‚ä¾‹å¤–ã‚’æŠ•ã’ã†ã‚‹å ´åˆã€ä¾‹å¤–ã‚’ä¼æ’­ã•ã›ã‚‹ãŸã‚ã®æ§‹æ–‡çš„ãªã‚³ã‚¹ãƒˆã¯ã‚¼ãƒ­ã§ã™ã€‚

```cpp
auto foo(int i) noexcept(false) -> int; // might throw an E
auto bar(int i) noexcept(false) -> int; // might throw an E

auto strcat(int i) noexcept(false) -> std::string {
  int f = foo(i);
  int b = bar(i);

  return std::format("{}{}", f, b);
}

// ã‚ã‚‹ã„ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã—ã¦ã“ã†æ›¸ã‘ã‚‹
auto strcat(int i) noexcept(false) -> std::string {
  return std::format("{}{}", foo(i), bar(i));
}
```

ä¾‹å¤–ã‚’ãƒãƒ³ãƒ‰ãƒ«ã›ãšã«ä¼æ’­ã•ã›ã‚‹ãŸã‚ã«ã¯ã€è¿½åŠ ã§ä½•ã‹ã‚’æ›¸ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãŸã ã—ã€ä¾‹å¤–ã«ã¯ãã®ä»–å¤šãã®å•é¡ŒãŒã‚ã‚‹ãŸã‚ã‚ã¾ã‚Šå¥½ã¾ã‚Œãšã€ãã®ä»£æ›¿æ‰‹æ®µã®ä¸€ã¤ã¨ã—ã¦C++23ã‹ã‚‰ã¯`std::expected<T, E>`ãŒä½¿ç”¨ã§ãã¾ã™ã€‚

```cpp
auto foo(int i) -> std::expected<int, E>;
auto bar(int i) -> std::expected<int, E>;

auto strcat(int i) -> std::expected<std::string, E> {
  auto f = foo(i);
  if (not f) {
    return std::unexpected(f.error());
  }

  auto b = bar(i);
  if (not b) {
    return std::unexpected(b.error());
  }

  return std::format("{}{}", *f, *b);
}
```

ã“ã¡ã‚‰ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒ«ã›ãšä¼æ’­ã•ã›ã‚‹å ´åˆã§ã‚‚ã€ãã®ãŸã‚ã®ã‹ãªã‚Šå†—é•·ãªã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ãªã‘ã‚Œã°ãªã‚‰ãšã€å€¤ã®å–ã‚Šå‡ºã—ã«ãŠã„ã¦ã‚‚`*`ã‚’ä½¿ç”¨ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€ãã®éš›ã«è€ƒæ…®ã™ã¹ãã“ã¨ãŒã„ãã¤ã‚‚æ½œã‚“ã§ã„ã¾ã™ï¼ˆé©åˆ‡ãªãƒ ãƒ¼ãƒ–ãªã©ï¼‰ã€‚

ãã®ãŸã‚ã€`std::expected`ã«ä¼¼ãŸæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ã€ã“ã®ã‚ˆã†ãªå‡¦ç†ã‚’ãƒã‚¯ãƒ­ã«ã‚ˆã£ã¦ãƒ©ãƒƒãƒ—ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

```cpp
auto strcat(int i) -> std::expected<std::string, E> {
  SOMETHING_TRY(int f, foo(i));
  SOMETHING_TRY(int b, bar(i));
  return std::format("{}{}", f, b);
}
```

ã“ã®å ´åˆã¯ä¾‹å¤–ã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«ã‹ãªã‚Šè¿‘ããªã‚Šã¾ã™ãŒã€ãƒã‚¯ãƒ­ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰`f, b`ã®å®£è¨€ã‚’çœã„ã¦ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ã“ã‚Œã‚‚ã¾ãŸãƒã‚¯ãƒ­ã‚’å·¥å¤«ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ãŒã€ãã‚Œã¯ç‰¹å®šã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©æ‹¡å¼µã«é ¼ã£ã¦ã„ãŸã‚Šé©åˆ‡ã«ãƒ ãƒ¼ãƒ–ã•ã‚Œãªã„ãªã©åŠ¹ç‡çš„ã¨ã¯è¨€ãˆãªã„ã‚‚ã®ã§ã™ã€‚

ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚’ç”¨ã„ã¦è¿‘ã—ã„ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚·ãƒ¥ã‚¬ãƒ¼ã‚’å†ç¾ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```cpp
auto strcat(int i) -> std::expected<std::string, E> {
  int f = co_await foo(i);
  int b = co_await bar(i);
  co_return std::format("{}{}", f, b);

  // ... or
  co_return std::format("{}{}", co_await foo(i), co_await bar(i));
}
```

ã—ã‹ã—ã€ç¾åœ¨ã®ã¨ã“ã‚ã‚³ãƒ«ãƒ¼ãƒãƒ³ã¯å‹•çš„ãªãƒ¡ãƒ¢ãƒªç¢ºä¿ã‚’å¿…ãšã—ã‚‚å›é¿ã§ããªã„ãŸã‚ã€ã“ã‚Œã‚‚ã¾ãŸåŠ¹ç‡çš„ãªã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

çµå±€ã®ã¨ã“ã‚ã€ç¾åœ¨ã®C++ã«ãŠã‘ã‚‹`std::expected`ã®ã‚¨ãƒ©ãƒ¼ä¼æ’­æ‰‹æ³•ã¨ã—ã¦ã¯ã€ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹ã‚‚ã®ãŒãƒ™ã‚¹ãƒˆã¨ãªã‚Šã¾ã™ã€‚

åˆ¥ã®è¨€èªã€ä¾‹ãˆã°Rustã§ã¯ã€`std::expected`ã«å¯¾å¿œã™ã‚‹`result`å‹ãŒã‚¨ãƒ©ãƒ¼ä¼æ’­ã«ã‚ˆãä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚Rustã§ã¯ã€å…ˆç¨‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚

<table>
<tr>
<th>Rust</th>
<th>C++</th>
</tr>
<tr>
<td valign="top">

```cpp
fn strcat(i: i32) -> Result<String, E> {
  let f = match foo(i) {
      Ok(i) => i,
      Err(e) => return Err(e),
  };

  let b = match bar(i) {
      Ok(i) => i,
      Err(e) => return Err(e),
  }

  Ok(format!("{}{}", f, b))
}
```

</td>
<td valign="top">

```cpp
auto strcat(int i) -> std::expected<std::string, E> {
  auto f = foo(i);
  if (not f) {
      return std::unexpected(f.error());
  }

  auto b = bar(i);
  if (not b) {
      return std::unexpected(b.error());
  }

  return std::format("{}{}", *f, *b);
}
```

</pre>
</td>
</tr>
</table>

ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã®åˆ©ç”¨ã«ã‚ˆã£ã¦ä¸­é–“å¤‰æ•°ãŒå¿…è¦ãªã„ãªã©ã€ã“ã‚Œã ã‘ã§ã‚‚Rustã®æ–¹ãŒè‰¯ã„æ›¸ãæ–¹ãŒã§ãã¾ã™ãŒã€Rustã«ãŠã„ã¦ã®ãƒ™ã‚¹ãƒˆãªæ›¸ãæ–¹ã¯ã“ã‚Œã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

<table>
<tr>
<th>Rust</th>
<th>C++(ä¾‹å¤–)</th>
</tr>
<tr>
<td valign="top">

```cpp
fn strcat(i: i32) -> Result<String, E> {
  let f = foo(i)?;
  let b = bar(i)?;
  Ok(format!("{}{}", f, b))

  // ... or simply ...
  Ok(format!("{}{}", foo(i)?, bar(i)?))
}
```

</td>
<td valign="top">

```cpp
auto strcat(int i) -> std::string {
  int f = foo(i);
  int b = bar(i);
  return std::format("{}{}", f, b);

  // ... or simply ...
  return std::format("{}{}", foo(i), bar(i));
}
```

</pre>
</td>
</tr>
</table>

ã“ã®å ´åˆã€1æ–‡å­—ï¼ˆ`?`ï¼‰ã®æ§‹æ–‡ä¸Šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã«ã‚ˆã£ã¦ã€C++ã®ä¾‹å¤–ã‚’ç”¨ã„ãŸã‚³ãƒ¼ãƒ‰ã¨ã»ã¼åŒç­‰ã®åŠè‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¼æ’­å‡¦ç†ã‚’è¨˜è¿°ã§ãã¦ã„ã¾ã™ã€‚1æ–‡å­—ã¨ã¯ã„ãˆã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã§ã¯ã‚ã‚Šã¾ã™ãŒã€`std::expected`ã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹ãƒã‚¯ãƒ­ã«æ¯”ã¹ãŸã‚‰ã“ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯ç„¡è¦–ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚

ç†æƒ³çš„ã«ã¯ã“ã‚Œã‚’C++ã«å°å…¥ã—ãŸã„ã®ã§ã™ãŒã€æ¡ä»¶æ¼”ç®—å­`?:`ã¨æ›–æ˜§ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã“ã®`?`ã‚’å˜é …å¾Œç½®æ¼”ç®—å­ã¨ã—ã¦å˜ç´”ã«å°å…¥ã§ãã¾ã›ã‚“ã€‚

```cpp
// ?:ã¨?ãŒã‚ã‚‹å ´åˆã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯
auto res = a ? * b ? * c : d;

// ä»¥ä¸‹ã®2ã¤ã®ãƒ‘ãƒ¼ã‚¹å…ˆãŒã‚ã‚‹
auto res1 = a ? (*(b?) * c) : d;
auto res2 = ((a?) * b) ? (*c) : d;
```

ãã®ãŸã‚ã€ã“ã®ææ¡ˆã§ã¯1æ–‡å­—å¢—ã‚„ã—ãŸ`??`æ¼”ç®—å­ã‚’`std::expected`ç­‰ã®ãŸã‚ã®ã‚¨ãƒ©ãƒ¼ä¼æ’­åŠè‡ªå‹•åŒ–æ§‹æ–‡ã¨ã—ã¦å°å…¥ã™ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¦ã„ã¾ã™ã€‚

ã“ã®æ¼”ç®—å­ã¯ä¸Šã§ç¤ºã—ãŸRustã®`?`ã«å¯¾å¿œã™ã‚‹ã‚‚ã®ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã¯ç¯„å›²`for`ã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œã¾ã™ã€‚

<table>
<tr>
<th>å±•é–‹å‰</th>
<th>å±•é–‹å¾Œ</th>
</tr>
<tr>
<td valign="top">

```cpp
auto strcat(int i) -> std::expected<std::string, E>{


  int f = foo(i)??;









  int b = bar(i)??;








  return std::format("{}{}", f, b);
}
```

</td>
<td valign="top">

```cpp
auto strcat(int i) -> std::expected<std::string, E> {
  using _Return = std::try_traits<
      std::expected<std::string, E>>;

  auto&& __f = foo(i);
  using _TraitsF = std::try_traits<
      std::remove_cvref_t<decltype(__f)>>;
  if (not _TraitsF::is_ok(__f)) {
      return _Return::from_error(
          _TraitsF::extract_error(FWD(__f)));
  }
  int f = _TraitsF::extract_value(FWD(__f));

  auto&& __b = bar(i);
  using _TraitsB = std::try_traits<
      std::remove_cvref_t<decltype(__b)>>;
  if (not _TraitsB::is_ok(__b)) {
      return _Return::from_error(
          _TraitsB::extract_error(FWD(__b)));
  }
  int b = _TraitsB::extract_value(FWD(__b));

  return std::format("{}{}", f, b);
}
```

</pre>
</td>
</tr>
</table>

å±•é–‹ã«å½“ãŸã£ã¦ã¯ã€å¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã¨ä¸­èº«ã®å€¤ã‚’å–ã‚Šå‡ºã™å¿…è¦ãŒã‚ã‚Šã€ã¾ãŸã€ãã‚Œã‚‰ã®å€¤ã‹ã‚‰æˆ»ã‚Šå€¤ã‚’ã©ã†æ§‹ç¯‰ã™ã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã‚’æ‹…ã£ã¦ã„ã‚‹ã®ãŒ`std::try_traits`ã¨ã„ã†å‹ç‰¹æ€§ã§ã€æ¬¡ã®é™çš„ãƒ¡ãƒ³ãƒé–¢æ•°ã‚’æŒã£ã¦ã„ã¾ã™

- `is_ok` : ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹
- `extract_value/extract_error` : æ­£å¸¸å€¤/ã‚¨ãƒ©ãƒ¼å€¤ã‚’å–å¾—ã™ã‚‹
- `from_value/from_error` : æ­£å¸¸å€¤/ã‚¨ãƒ©ãƒ¼å€¤ã‹ã‚‰ãã®å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹

ã“ã‚Œã¯ã€`std::expected`ã®ã‚ˆã†ãªå‹ã«å¯¾ã—ã¦ç°¡å˜ã«ã‚¢ãƒ€ãƒ—ãƒˆã§ãã¾ã™ã€‚

```cpp
// std::optionalã§ã®ä¾‹
template <class T>
struct try_traits<optional<T>> {
  using value_type = T;
  using error_type = nullopt_t;

  auto is_ok(optional<T> const& o) -> bool {
    return o.has_value();
  }

  // extractors
  auto extract_value(auto&& o) -> auto&& {
    return *FWD(o);
  }
  auto extract_error(auto&&) -> error_type {
    return nullopt;
  }

  // factories
  auto from_value(auto&& v) -> optional<T> {
    return optional<T>(in_place, FWD(v));
  }
  auto from_error(nullopt_t) -> optional<T> {
    return {};
  }
};

// std::expectedã§ã®ä¾‹
template <class T, class E>
struct try_traits<expected<T, E>> {
  using value_type = T;
  using error_type = E;

  auto is_ok(expected<T, E> const& e) -> bool {
    return e.has_value();
  }

  // extractors
  auto extract_value(auto&& e) -> auto&& {
    return *FWD(e);
  }
  auto extract_error(auto&& e) -> auto&& {
    return FWD(e).error();
  }

  // factories
  auto from_value(auto&& v) -> expected<T, E> {
    return expected<T, E>(in_place, FWD(v));
  }
  auto from_error(auto&& e) -> expected<T, E> {
    return expected<T, E>(unexpect, FWD(e));
  }
};
```

ã¾ãŸã€ã“ã®ææ¡ˆã®`try_traits`ã¯C#ç­‰ã®nullæ¡ä»¶æ¼”ç®—å­`?.`ã®ã‚ˆã†ãªæ¼”ç®—å­ã®ãŸã‚ã«å¿…è¦ãªã‚‚ã®ã‚’ã™ã¹ã¦æä¾›ã—ã¾ã™ã€‚

```cpp
auto f(int) -> std::expected<std::string, E>;

// å°†æ¥ã®å¯èƒ½æ€§ï¼Ÿ
auto x = f(42)?.size();
```

- [P2561 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1276)

### [P2579R0 Mitigation strategies for P2036 â€œChanging scope for lambda trailing-return-typeâ€](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2579r0.pdf)

P2036R3ã«ã‚ˆã‚‹å¾Œæ–¹éäº’æ›æ€§ã‚’ç·©å’Œã™ã‚‹ææ¡ˆã€‚

P2036R3ï¼ˆãƒ©ãƒ ãƒ€å¼ã®å¾Œç½®æˆ»ã‚Šå€¤å‹ãŒã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹å¤‰æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®å¤‰æ›´ï¼‰ã¯C++23ã®WDã«å°å…¥ã•ã‚Œã¦ãŠã‚Šã€ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾ã™ã‚‹DRã¨ã—ã¦æ¡æŠã•ã‚Œã¦ã„ã¾ã™ã€‚P2036ã«ã¤ã„ã¦ã¯ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§ã€‚

- [P2036R1 Changing scope for lambda trailing-return-type - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´01æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/02/11/153333#P2036R1-Changing-scope-for-lambda-trailing-return-type)

ã“ã®ææ¡ˆã®æ¤œè¨æ®µéšã§ã¯ã€ã“ã®å¤‰æ›´ã«ã‚ˆã£ã¦å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã»ã¼ç„¡ã„ã ã‚ã†ã¨æ€ã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€clangã§å®Ÿè£…ã•ã‚ŒãŸã¨ã“ã‚clangãã®ã‚‚ã®ï¼ˆllvm/libstdc++ï¼‰ã®ã‚³ãƒ¼ãƒ‰ã‚’å£Šã—ã¦ã„ã‚‹äº‹ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚ãã‚Œã¯æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ã™

```cpp
// ãªã‚“ã‹ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ç¯„å›²ã®endã®å€¤
auto local_end = ...;

[local_end](decltype(local_end) it) { return it != local_end; };
//          ^^^^^^^^^^^^^^^^^^^
```

å¾Œç½®æˆ»ã‚Šå€¤å‹æŒ‡å®šã§ã¯ãªãå¼•æ•°å‹ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸå¤‰æ•°ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€P2036R3ã§ã¯ã“ã‚Œã¯ill-formedã¨ã—ã¦ã„ã¾ã™ã€‚ãªãœãªã‚‰ã€ã“ã“ã§ã¯ã¾ã `mutable`ãŒè¦‹ãˆã¦ã„ãªã„ãŸã‚ã€`decltype((x))`ã®å‹ã‚’æ­£ã—ãæ±‚ã‚ã‚‹äº‹ãŒã§ããªã„ãŸã‚ã§ã™ã€‚ã—ã‹ã—ã€ä»¥å‰ã¯ã“ã®`x`ã¯å¤–ã®å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã„ãŸãŸã‚å•é¡Œã«ãªã‚‰ãšã€å°‘ãªãã¨ã‚‚ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸäººé–“ã®æ„å›³é€šã‚Šã«ã¯å‹•ã„ã¦ã„ã¾ã—ãŸã€‚

ã“ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¯[CWG2569](https://cplusplus.github.io/CWG/issues/2569.html)ã¨ã—ã¦å ±å‘Šã•ã‚Œã€ã“ã‚Œã‚’å…ˆè¡Œå®Ÿè£…ã™ã‚‹ã“ã¨ã§è§£æ±ºã•ã‚Œã¾ã—ãŸã€‚ã“ã“ã§ã¯ã€`mutable`ãŒç¾ã‚Œã‚‹ï¼ˆå ´æ‰€ã«åˆ°é”ã™ã‚‹ï¼‰å‰ã«ã‚­ãƒ£ãƒ—ãƒãƒ£å¤‰æ•°ãŒ`decltype`ãªã©ã§ä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã€`decltype(x)`ã¯è¨±å¯ã™ã‚‹ã‚‚ã®ã®`decltype((x))`ã¯è¨±å¯ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§`mutable`ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ã—ã¤ã¤æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãŒå£Šã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ãã®å¾Œã€æ¬¡ã®ã‚ˆã†ãªåˆ¥ã®ã‚³ãƒ¼ãƒ‰ãŒå£Šã‚Œã¦ã„ã‚‹äº‹ãŒå ±å‘Šã•ã‚Œã¾ã—ãŸ

```cpp
template <typename It, typename MapFn>
auto MapJoin(It first, It last, MapFn map_fn) {
  return std::accumulate(first, last, map_fn(*first),
                         // a new diagnostic: error: captured variable 'first' cannot appear here
                         [=](typename std::result_of<MapFn(decltype(*first))>::type result) { });
}

void foo() {
  int x = [x](int y[sizeof x]) { return sizeof x; }(0);
}
```

ã“ã‚Œã‚‰ã®ã‚³ãƒ¼ãƒ‰ç ´å£ŠãŒå ±å‘Šã•ã‚ŒãŸçµæœclangã§ã¯P2036ã®å®Ÿè£…ã‚’ä¸€æ—¦åœæ­¢ã—ãŸãŸã‚ã“ã‚Œä»¥ä¸Šã®ç ´æä¾‹ã‚’åé›†ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€å®Ÿè£…ã•ã‚ŒãŸå ´åˆã‚ˆã‚Šå¤šãã®ã‚³ãƒ¼ãƒ‰ã‚’å£Šã™ã“ã¨ã«ãªã‚‹äº‹ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚çµæœã¨ã—ã¦ã€clangã®å®Ÿè£…è€…ï¼ˆç­†è€…ã®æ–¹ï¼‰ã¯P2036R3ã¯å®Ÿè£…ä¸å¯èƒ½ã§ã‚ã‚‹ã¨è€ƒãˆã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚³ãƒ¼ãƒ‰ã«å…±é€šã™ã‚‹ã“ã¨ã¯ã€C++11æ™‚ç‚¹ã§ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ©ãƒ ãƒ€ãŒå°å…¥ã•ã‚Œã¦ã„ãªã‹ã£ãŸã“ã¨ã«ã‚ˆã‚‹ä»£æ›¿æ‰‹æ®µã§ã‚ã‚‹ã‚ˆã†ã«æ€ã‚ã‚Œã¾ã™ã€‚å¾“ã£ã¦ã€ç¾åœ¨ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ©ãƒ ãƒ€ã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’C++11ã§æ›¸ã“ã†ã¨ã—ãŸå ´åˆã«P2036ã«é•åã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«ãªã‚‹å¯èƒ½ãŒã‚ã‚Šã€ã‚³ãƒ¼ãƒŠãƒ¼ã‚±ãƒ¼ã‚¹ã§ã‚ã‚‹ã¨åˆ‡ã£ã¦æ¨ã¦ã‚‰ã‚Œã‚‹ã»ã©ãŠã‹ã—ãªã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã®ææ¡ˆã¯ã€P2036R3ã®å¤‰æ›´ã‚’ä¿®æ­£ã—ã¦ãã®æ‚ªå½±éŸ¿ã‚’ç·©å’Œã—ã‚ˆã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã“ã“ã§ã¯ã€5ã¤ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒæç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

1. CWG2569ã®ä¿®æ­£
2. `mutable`ãŒç¾ã‚ŒãŸå ´åˆã€ãƒ©ãƒ ãƒ€å¼ã®å¼•æ•°å®£è¨€å†…ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’å‚ç…§ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ill-formedã«ã™ã‚‹
3. ãƒ‘ãƒ¼ã‚¹æ™‚ã«`mutable`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ˆèª­ã¿ã™ã‚‹
4. ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã‚‚ã®ã®ã€å¸¸ã«`mutable`æœ‰ç„¡ã‚’è€ƒæ…®ã—ãªã„

EWGã§ã¯5ç•ªç›®ã®è§£æ±ºç­–ãŒé¸æŠã•ã‚Œã€ã“ã®ææ¡ˆã¯ãã®ãŸã‚ã®æ–‡è¨€ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚

ãã‚Œãã‚Œã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã®æ¦‚è¦ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™

1. CWG2569ã®ä¿®æ­£
      - ãƒ©ãƒ ãƒ€ã®å¤‰æ•°å®£è¨€éƒ¨ã§ä¸€éƒ¨ã®ç”¨æ³•ï¼ˆ`decltype(x)`ãªã©ï¼‰ã ã‘ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ 
      - è¨±å¯ã•ã‚Œã‚‹ã‹ãŒå¼ã«å·¦å³ã•ã‚Œã‚‹ãŸã‚ç†è§£ã—ã¥ã‚‰ã„ï¼ˆ`decltype(*x)`ã¯ngãªã©ï¼‰
      - å‰è¿°ã®é€šã‚Šã€ã“ã‚Œã ã‘ã§ã¯ç ´æã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã¾ã ã‚ã‚‹
2. `mutable`ãŒç¾ã‚Œã‚‹å‰ã¯ã€ãƒ©ãƒ ãƒ€ã®å¤–å´ã®å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹
      - ã¤ã¾ã‚ŠC++20ä»¥å‰ï¼ˆç¾åœ¨ï¼‰ã®æŒ™å‹•
      - `decltype(expr)`ã®çµæœãŒ`mutable`ã®å‰å¾Œã§ç•°ãªã‚‹ã“ã¨ã¯ãƒ©ãƒ ãƒ€å¼æœ¬ä½“é–‹å§‹ï¼ˆ`{`ï¼‰ã®å‰å¾Œã§ç•°ãªã‚‹ã“ã¨ã‚ˆã‚Šã‚‚è‰¯ã„ã¨ã¯è¨€ãˆãªã„
3. `mutable`ãŒç¾ã‚ŒãŸå ´åˆã€ãƒ©ãƒ ãƒ€å¼ã®å¼•æ•°å®£è¨€å†…ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’å‚ç…§ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ill-formedã«ã™ã‚‹
      - ç ´æã¯æ¸›å°‘ã™ã‚‹ãŒå®Œå…¨ã§ã¯ãªã„
      - å¾Œã‹ã‚‰è¦‹ã¤ã‹ã‚‹`mutable`ã«ã‚ˆã£ã¦ã‚¨ãƒ©ãƒ¼æœ‰ç„¡ãŒå¤‰ã‚ã‚‹ã®ã¯å¥‡å¦™
4. ãƒ‘ãƒ¼ã‚¹æ™‚ã«`mutable`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ˆèª­ã¿ã™ã‚‹
      - å®Œç’§ã§ã¯ç„¡ã„ã‚‚ã®ã®ã€æœ€å–„ã®è§£æ±ºç­–
      - å®Ÿè£…ã®è² æ‹…ãŒå¤§ãã„
      - å¾Œã‹ã‚‰è¦‹ã¤ã‹ã‚‹`mutable`ã«ã‚ˆã£ã¦æ§‹æ–‡ã®æ„å‘³ãŒå¤‰ã‚ã‚‹ã®ã¯å¥‡å¦™
5. ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã‚‚ã®ã®ã€å¸¸ã«`mutable`æœ‰ç„¡ã‚’è€ƒæ…®ã—ãªã„
      - `decltype((x))`ã®æŒ¯ã‚‹èˆã„ãŒé–¢æ•°å¼•æ•°éƒ¨åˆ†ã®çµ‚ç«¯ã®å‰å¾Œã§å¤‰åŒ–ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

ãªãŠã€ã“ã®å ´åˆã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸå¤‰æ•°`x`ã‚’å‚ç…§ã™ã‚‹`decltype((x))`ã¯`x`ãŒ`const`ã§ãªã„é™ã‚Šé`const`ã¨ãªã‚Šã¾ã™ã€‚ã™ãªã‚ã¡ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`mutable`ãŒã‚ã‚‹ã‹ã®ã‚ˆã†ã«æ‰±ã„ã¾ã™ã€‚

```cpp
void f() {
  float x, &r = x;

  [=](decltype((x)) y) {
    decltype((x)) z = x;
  };  // okã€yã®å‹ã¯float&, zã®å‹ã¯const float&

  [=] {
    []<decltype(x) P>;      // ok
    [](decltype((x)) y){};  // okã€yã®å‹ã¯float const&ï¼ˆå›²ã‚€ãƒ©ãƒ ãƒ€ãŒã‚³ãƒ”ãƒ¼ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸxã‚’å‚ç…§ã—ã¦ã„ã‚‹ï¼‰
    [x=1](decltype((x)) y){
      decltype((x)) z = x;
    };  // ok, yã®å‹ã¯int&, zã®å‹ã¯const int&
  };
}
```

ã“ã®ææ¡ˆã¯ã€CWG Issueã¨é–¢é€£ã™ã‚‹ææ¡ˆã§ã‚‚ã‚ã‚‹ã“ã¨ã‹ã‚‰ã™ã§ã«CWGã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ‘ã‚¹ã—ã¦ãŠã‚Šã€æ¬¡ã®å…¨ä½“ä¼šè­°ã§æŠ•ç¥¨ã«ã‹ã‘ã‚‰ã‚Œã‚‹äº‹ãŒæ±ºã¾ã£ã¦ã„ã¾ã™ã€‚

- [P2598R0 â€œChanging scope for lambda trailing-return-typeâ€ (P2036) should not be a DR - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2022å¹´06æœˆï¼‰](https://onihusube.hatenablog.com/entry/2022/07/09/160343#P2598R0-Changing-scope-for-lambda-trailing-return-type-P2036-should-not-be-a-DR)
- [CWG Issue 2569. Use of `decltype(capture)` in a lambda's parameter-declaration-clause](https://cplusplus.github.io/CWG/issues/2569.html)
- [P2579 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1274)

### [P2585R1 Improving default container formatting](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2585r1.html)
### [P2587R1 to_string or not to_string](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2587r1.html)
### [P2590R2 Explicit lifetime management](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2590r2.pdf)
### [P2592R1 Hashing support for std::chrono value classes](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2592r1.html)
### [P2601R1 Make redundant empty angle brackets optional](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2601r1.html)
### [P2602R1 Poison Pills are Too Toxic](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2602r1.html)
### [P2609R1 Relaxing Ranges Just A Smidge](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2609r1.html)
### [P2610R0 2022-07 Library Evolution Polls](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2610r0.html)

2022å¹´ã®5æœˆã«äºˆå®šã•ã‚Œã¦ã„ã‚‹ã€LEWGã§ã®å…¨ä½“æŠ•ç¥¨ã®äºˆå®šè¡¨ã€‚

æ¬¡ã®ææ¡ˆãŒã€LWGã«é€²ã‚€ãŸã‚ã®æŠ•ç¥¨ã«ã‹ã‘ã‚‰ã‚Œã¾ã™ã€‚

- C++23
    - [P0429R9 flat_map](https://wg21.link/P0429R9)
    - [P1222R4 flat_set](https://wg21.link/P1222R4)
    - [P0792R10 function_ref](https://wg21.link/P0792R10)
    - [P2505R4 Monadic Functions For expected](https://wg21.link/P2505R4)
    - [P2585R0 Improving Default Container Formatting](https://wg21.link/P2585R0)
    - [P2446R2 views::as_rvalue](https://wg21.link/P2446R2)
    - [P2278R4 cbegin Should Always Return A Constant Iterator](https://wg21.link/P2278R4)
    - [P2248R5 Enabling List-Initialization For Algorithms](https://wg21.link/P2248R5)
    - [P2539R1 Should The Output Of print To A Terminal Be Synchronized With The Underlying Stream?](https://wg21.link/P2539R1)
    - [P2510R3 Formatting Pointers](https://wg21.link/P2510R3)
    - [P2551R2 Clarify Intent Of Individually Specializable Numeric Traits](https://wg21.link/P2551R2)
    - [P2599R2 index_type & size_type In mdspan](https://wg21.link/P2599R2)
    - [P2604R0 mdspan: Rename pointer, data, And contiguous](https://wg21.link/P2604R0)
    - [P2613R1 Add The Missing empty To mdspan](https://wg21.link/P2613R1)
- C++26
    - [P2338R2 Freestanding Library: Character Primitives And The C Library](https://wg21.link/P2338R2)
    - [P2407R1 Freestanding Library: Partial Classes](https://wg21.link/P2407R1)
    - [P2562R1 constexpr Stable Sorting](https://wg21.link/P2562R1)
    - [P2283R2 constexpr Specialized Memory Algorithms](https://wg21.link/P2283R2)
    - [P2542R2 views::concat](https://wg21.link/P2542R2)
    - [P2609R1 Relaxing Ranges Just A Smidge](https://wg21.link/P2609R1)

### [P2613R1 Add the missing `empty` to `mdspan`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2613r1.html)

`std::mdspan`ã«`empty()`ãƒ¡ãƒ³ãƒé–¢æ•°ã‚’è¿½åŠ ã™ã‚‹ææ¡ˆã€‚

ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2613R0 Add the missing `empty` to `mdspan`](https://onihusube.hatenablog.com/entry/2022/07/09/160343#P2613R0-Add-the-missing-empty-to-mdspan)


ã“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ã¯ã€LWGã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ã¦ã®æ–‡è¨€èª¿æ•´ã®ã¿ã§ã™ã€‚

ã“ã®ææ¡ˆã¯ä»Šå›ï¼ˆ2022/07ï¼‰ã®å…¨ä½“ä¼šè­°ã§æ‰¿èªã•ã‚Œã€C++23å…¥ã‚Šã—ã¦ã„ã¾ã™ã€‚

- [P2613 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1272)

### [P2614R0 Deprecate `numeric_limits::has_denorm`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2614r0.pdf)

`std::numeric_limits::has_denorm`é–¢é€£ã®å®šæ•°ã‚’éæ¨å¥¨åŒ–ã™ã‚‹ææ¡ˆã€‚

[`std::numeric_limits::has_denorm`](https://cpprefjp.github.io/reference/limits/numeric_limits/has_denorm.html)ã¯ãã®ç’°å¢ƒã§ã€æµ®å‹•å°æ•°ç‚¹æ•°å‹`T`ãŒéæ­£è¦åŒ–æ•°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã‚’èª¿ã¹ã‚‹ã‚‚ã®ã§ã™ã€‚ã“ã‚Œã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚å®šæ•°ã§ã‚ã‚Šã€æµ®å‹•å°æ•°ç‚¹æ•°å‹`T`éæ­£è¦åŒ–æ•°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹/ã„ãªã„/ã‚ã‹ã‚‰ãªã„ã€ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«å–å¾—ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

IEE754æº–æ‹ ã®æµ®å‹•å°æ•°ç‚¹æ•°å‹ã§ã‚ã£ã¦ã‚‚ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã«ã‚ˆã£ã¦ã¯éæ­£è¦åŒ–æ•°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆãŒã‚ã‚Šãã®å ´åˆã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€åŒã˜ç³»çµ±ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã§ã‚ã£ã¦ã‚‚å°†æ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ã“ã®æ™‚ã«ABIç ´å£Šã‚’å›é¿ã—ã‚ˆã†ã¨æ€ã†ã¨`std::denorm_indeterminate`ã‚’å¸¸ã«ä½¿ç”¨ã›ã–ã‚‹ã‚’å¾—ãªããªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚µãƒãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã§ã‚‚ã€å®Ÿè¡Œæ™‚ã®ãƒ•ãƒ©ã‚°åˆ‡ã‚Šæ›¿ãˆã«ã‚ˆã£ã¦éæ­£è¦åŒ–æ•°ã‚’ã‚¼ãƒ­ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹äº‹ãŒå¯èƒ½ã§ã‚ã‚Šã€`std::numeric_limits::has_denorm`ã¯å¿…ãšã—ã‚‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ç¢ºå®šã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã¯ç„¡ã„é¢ãŒã‚ã‚Šã¾ã™ã€‚

`std::numeric_limits::has_denorm_loss`ã¯éæ­£è¦åŒ–æ•°ãŒä½œæˆã•ã‚Œï¼ˆè¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œï¼‰ã‚‹å ´åˆã«èµ·ã“ã‚‹ç²¾åº¦ã®ä½ä¸‹ã‚’ã©ã®ã‚ˆã†ã«æ¤œå‡ºã§ãã‚‹ã‹ã‚’å–å¾—ã™ã‚‹ã‚‚ã®ã§ã™ã€‚éæ­£è¦åŒ–æ•°ãŒä½¿ç”¨ã•ã‚ŒãŸã“ã¨ã«ã‚ˆã£ã¦ç²¾åº¦ãŒä½ä¸‹ã—ãŸæ™‚ã«ãã‚Œã‚’æ¤œå‡ºã™ã‚‹æ¬¡ã®2ã¤ã®æ–¹æ³•ãŒIEEE754æ¨™æº–ã§æŒ‡å®šã•ã‚Œã¦ã„ã¾ã—ãŸ

1. éæ­£è¦åŒ–æå¤±ï¼ˆDenormalization lossï¼‰
2. ä¸æ­£ç¢ºãªçµæœï¼ˆInexact resultï¼‰

å®Ÿéš›ã«ã¯1ã¤ç›®ã®å®Ÿè£…ã¯å­˜åœ¨ã—ãªã‹ã£ãŸãŸã‚ã€ç¾åœ¨ã®IEE754ã‹ã‚‰ã¯å‰Šé™¤ã•ã‚Œã¦ãŠã‚Šã€2ã¤ç›®ã®å®Ÿè£…ã ã‘ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚`std::numeric_limits::has_denorm_loss`ã¯ã“ã®2ã¤ã®ã©ã¡ã‚‰ãŒãã®ç’°å¢ƒã®æµ®å‹•å°æ•°ç‚¹æ•°å‹ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¤ºã™ã‚‚ã®ã§ã—ãŸãŒã€ã“ã®ã‚ˆã†ãªç†ç”±ã«ã‚ˆã‚Šã‚‚ã¯ã‚„æ„å‘³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€ã“ã®å€¤ã¯å®Ÿè£…ã«ã‚ˆã£ã¦ãªãœã‹ç•°ãªã£ã¦ã„ã¾ã™ï¼ˆMSVCã ã‘ãŒæµ®å‹•å°æ•°ç‚¹æ•°å‹ã«å¯¾ã—ã¦`true`ã‚’è¿”ã™ï¼‰ã€‚

ã“ã‚Œã‚‰ã®ç†ç”±ã‹ã‚‰ã€`std::numeric_limits::has_denorm`ã¨`std::numeric_limits::has_denorm_loss`ã¯æœ‰ç”¨ãªã‚‚ã®ã§ã¯ãªãã€æœ€æ‚ªå‹˜é•ã„ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹å±é™ºæ€§ãŒã‚ã‚‹ãŸã‚ã€éæ¨å¥¨åŒ–ã—ã‚ˆã†ã¨ã™ã‚‹ææ¡ˆã§ã™ã€‚ãŸã ã—ã€å‰Šé™¤ã—ã¦ã—ã¾ã†ã¨äº’æ›æ€§ã®å•é¡Œã‚’å¼•ãèµ·ã“ã™ãŸã‚ã€éæ¨å¥¨ã«æ­¢ã‚ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

- [`std::numeric_limits<T>::has_denorm_loss` - cppreference](https://en.cppreference.com/w/cpp/types/numeric_limits/has_denorm_loss)
- [P2614 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1278)

### [P2615R0 Meaningful exports](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2615r0.html)

ç„¡æ„å‘³ãª`export`ã‚’è¡Œãˆãªã„ã‚ˆã†ã«ã™ã‚‹ææ¡ˆã€‚

ç¾åœ¨ã®`export`å®£è¨€ã«ã¾ã¤ã‚ã‚‹è¦å®šã®è§£é‡ˆã®ä¸€ã¤ã¨ã—ã¦ã€æ¬¡ã®ã‚ˆã†ãªå®£è¨€ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

```cpp
// ã“ã‚Œã¯ä½•ï¼Ÿ
template export void f();
export template void f();

// æœ¬ä½“ã®é–¢æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒexportã•ã‚Œã¦ã„ã‚‹ãªã‚‰ã“ã¡ã‚‰ã«ã¯ä¸è¦
export template<> void g(int);
template<> export void g(int);

// ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒexportã•ã‚Œã¦ã„ã‚Œã°ä¸è¦
export template<class T> struct trait<T*>;
```

ã“ã®å•é¡Œã¯ã‚³ã‚¢è¨€èªã®issueã¨ã—ã¦æèµ·ã•ã‚Œã€ã“ã®ææ¡ˆã¯ãã®è§£æ±ºã®ãŸã‚ã®æ–‡è¨€å¤‰æ›´ã‚’å«ã‚“ã ã‚‚ã®ã§ã™ã€‚

ãŸã ã—ã€ã“ã®å¾Œã§ã‚‚`export {...}`ã®ä¸­ã§ã“ã‚Œã‚‰ã®å®£è¨€ãŒç¾ã‚ŒãŸã¨ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã•ã‚Œã¦ã„ã¾ã™ã€‚`export`ãƒ–ãƒ­ãƒƒã‚¯å†…ã§ã¯åˆ©ä¾¿æ€§å‘ä¸Šã®ãŸã‚ã«ã€æœ¬æ¥`export`ã§ããªã„å®£è¨€ãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚å˜ã«ç„¡è¦–ã•ã‚Œã‚‹ã‚ˆã†ã«ã•ã‚Œã‚‹ï¼ˆã‚ˆã†ã«ã™ã‚‹å‚¾å‘ã«ã‚ã‚‹ï¼‰ãŸã‚ã§ã™ã€‚

- [CWG Issue 2443. Meaningless template exports](https://www.open-std.org/jtc1/sc22/wg21/docs/cwg_active.html#2443)
- [P2615 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1236)

### [P2616R0 Making `std::atomic` notification/wait operations usable in more situations](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2616r0.html)

`std::atomic`ã®[`notify_one()`](https://cpprefjp.github.io/reference/atomic/atomic/notify_one.html)ã¨[`wait()`](https://cpprefjp.github.io/reference/atomic/atomic/wait.html)æ“ä½œã‚’ä½¿ã„ã¥ã‚‰ãã—ã¦ã„ã‚‹å•é¡Œã‚’è§£æ¶ˆã™ã‚‹ææ¡ˆã€‚

`std::atomic`ã®`notify_one()/wait()`æ“ä½œã¯C++23ã§è¿½åŠ ã•ã‚Œã€`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä»‹ã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰é–“ã®åŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚

ãŸã ã€å¾…æ©Ÿã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èµ·åºŠã•ã›ã‚‹`notify_one()`æ“ä½œã¨`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‡ºåŠ›ï¼ˆ`.store()`ï¼‰ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ ã“ã‚Œã‚’åˆ©ç”¨ã—ãŸåŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã®ç§»æ¤å¯èƒ½ãªå®Ÿè£…ã‚’å¦¨ã’ã¦ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€`std::atomic`ã®`notify_one()/wait()`ã®ã‚ˆãã‚ã‚‹ä½¿ç”¨æ³•ã§ã¯ã€`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸å€¤ã‚’å‡ºåŠ›ã—ã¦ã‹ã‚‰`notify_one()`ã‚’å‘¼ã¶ã¨ã„ã†æ‰‹é †ãŒã¨ã‚‰ã‚Œã¾ã™ã€‚ã“ã®å ´åˆã«ã€å¾…æ©Ÿã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãŒ`wait()`ã‹ã‚‰ã®å¾©å¸°æ™‚ã«åŒæœŸã«ä½¿ç”¨ã—ã¦ã„ãŸ`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã™ãã«ç ´æ£„ã™ã‚‹å ´åˆã«å•é¡ŒãŒèµ·ã“ã‚Šã¾ã™ã€‚

å¾…æ©Ÿã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã§`wait()`ãŒå‘¼ã°ã‚Œã‚‹å‰ã«ï¼ˆæ­£ç¢ºã«ã¯ã€ãã®å‘¼ã³å‡ºã—ã§å€¤ã®ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã‚‹å‰ã«ï¼‰ã€é€šçŸ¥ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆ`notify_one()`ã‚’å‘¼ã¶ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰ã§`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å€¤ã®å‡ºåŠ›ãŒè¡Œã‚ã‚Œã¦ã„ãŸå ´åˆã€å¾…æ©Ÿã‚¹ãƒ¬ãƒƒãƒ‰ã®`wait()`ã¯ã™ãã«ãƒªã‚¿ãƒ¼ãƒ³ã—ä½¿ç”¨ã—ã¦ã„ãŸ`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç ´æ£„ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã™ã‚‹ã¨ã€é€šçŸ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ãã®ã‚ˆã†ã«ç ´æ£„ã•ã‚Œã¦ã—ã¾ã£ãŸ`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦`notify_one()`ã‚’å‘¼ã¶å¯èƒ½æ€§ãŒã‚ã‚Šã€ã“ã‚Œã¯ã„ã†ã¾ã§ã‚‚ãªãæœªå®šç¾©å‹•ä½œã§ã™ã€‚

```cpp
#include <atomic>
#include <thread>

int main() {
  {
    // åŒæœŸç”¨ã‚¢ãƒˆãƒŸãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    std::atomic<bool> sync = false;

    std::thread{[&sync]{
      // å€¤ã‚’trueã«æ›´æ–°ã—ã¦ã‹ã‚‰
      sync.store(true);   // #1
      // å¾…æ©Ÿã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èµ·åºŠã•ã›ã‚‹
      sync.notify_one();  // #2
    }}.detach();

    // å€¤ãŒæ›´æ–°ï¼ˆtrueã«ãªã‚‹ï¼‰ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    sync.wait(false); // #3
    // çµ‚ã‚ã£ãŸã‚‰å³ãƒªã‚¿ãƒ¼ãƒ³ã€syncã¯ç ´æ£„ã•ã‚Œã‚‹
  } // #4
}
```

`.wait()`ã§ã¯å¼•æ•°ã«æ¸¡ã•ã‚ŒãŸå€¤ã¨ç¾åœ¨ã®å€¤ã‚’æ¯”è¼ƒã—ã¦ã€ç­‰ã—ã„å ´åˆã«ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã—ã€ç­‰ã—ãç„¡ã„å ´åˆã¯ã™ããƒªã‚¿ãƒ¼ãƒ³ã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯å‡¦ç†ãŒ`#1 -> #3 -> #4 -> #2`ã®é †ç•ªã§èµ·ã“ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€èµ·ã“ã£ãŸå ´åˆã«æœªå®šç¾©å‹•ä½œã¨ãªã‚Šã¾ã™ã€‚

ã“ã®ä¾‹ã¯æ£æ„çš„ã«è¦‹ãˆã¾ã™ãŒã€ä¾‹ãˆã°`std::atomic`ã‚’ç”¨ã„ã¦`std::binary_semaphore`ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãŸå ´åˆã€ã“ã®ã“ã¨ã¯è¡¨é¢åŒ–ã—ã¾ã›ã‚“ãŒåŒæ§˜ã®å•é¡Œã‚’æ½œåœ¨çš„ã«å¼•ãèµ·ã“ã—ã¾ã™ã€‚

```cpp
#include <semaphore>
#include <thread>

int main() {
  {
    // binary_semaphoreãŒstd::atomicã‚’ç”¨ã„ã¦å®Ÿè£…ã•ã‚Œã¦ã„ãŸã¨ã™ã‚‹ã¨ãƒ»ãƒ»ãƒ»
    std::binary_semaphore sync;

    std::thread{[&sync]{
      sync.release();
    }}.detach();

    sync.acquire();
  }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã ã¨å…ˆã»ã©ã‚ˆã‚Šã‚‚å•é¡ŒãŒè¦‹ãˆã«ãããªã£ã¦ã„ã¾ã™ã€‚`std::atomic`ã¨`notify_one()/wait()`ã‚’ç”¨ã„ã¦ä»–ã®åŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã¯ã“ã®å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã®å·¥å¤«ãŒå¿…è¦ã«ãªã‚Šã€ãã‚Œã‚‰ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æã­ãŸã‚Šç§»æ¤æ€§ãŒç„¡ã‹ã£ãŸã‚Šã¨å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

å®Ÿã¯æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸»è¦3å®Ÿè£…ï¼ˆGCC/clang/MSVCï¼‰ã«ãŠã‘ã‚‹`std::binary_semaphore`ï¼ˆ`std::counting_semaphore`ï¼‰ã¯ã¾ã•ã«`std::atomic`ã‚’åˆ©ç”¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã—ã€ãã“ã§ã¯`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã‚’ä½¿ç”¨ã—ã¦å€¤ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ãŸã‚ã€ä¸Šè¨˜ã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã«ã¾ã¤ã‚ã‚‹å•é¡Œã¯èµ·ã“ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã“ã‚Œã¯ã€ã“ã®3ã¤ã®å®Ÿè£…ãŒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å¯¾å¿œã™ã‚‹æ“ä½œã«é–¢ã™ã‚‹è¿½åŠ ã®çŸ¥è­˜ã‚’ä»®å®šã§ãã‚‹ãŸã‚ã«å¯èƒ½ã«ãªã£ã¦ã„ã‚‹ã ã‘ã§ã€ãã®ä»–ã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå®Ÿè£…ãŒã“ã®æ–¹æ³•ã‚’å–ã‚‹ã‹ã©ã†ã‹ã¯ã‚ã‹ã‚‰ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åŒæ§˜ã®ä»®å®šã®ã‚‚ã¨ã§`std::atomic`ã‚’ä½¿ç”¨ã—ã¦`std::binary_semaphore`ã®ã‚ˆã†ãªã‚‚ã®ã‚’å®‰å…¨ã‹ã¤ç§»æ¤å¯èƒ½ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ã“ã®ææ¡ˆã¯ã“ã®å•é¡Œã®è§£æ±ºã‚’å›³ã‚‹ã‚‚ã®ã§ã€æ¬¡ã®2ã¤ã®è§£æ±ºç­–ã‚’æç¤ºã—ã¦ã„ã¾ã™ã€‚

1. åå‰ç©ºé–“ã‚¹ã‚³ãƒ¼ãƒ—ã®[`std::atomic_notify_one()`](https://cpprefjp.github.io/reference/atomic/atomic_notify_one.html)/[`std::atomic_notify_all()`](https://cpprefjp.github.io/reference/atomic/atomic_notify_all.html)ã®è¦å®šã‚’å¤‰æ›´ã—ã¦ã€ç”Ÿå­˜æœŸé–“ãŒçµ‚äº†ã—ã¦ã„ã‚‹`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æ¸¡ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
    - æ¸¡ã•ã‚ŒãŸãƒã‚¤ãƒ³ã‚¿ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹
2. `std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`.store()`ã‚’å‘¼ã³å‡ºã™å¯èƒ½æ€§ãŒã‚ã‚‹é–¢æ•°ã”ã¨ã«ã€é€šçŸ¥æ“ä½œã‚’èåˆã—ãŸã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã€‚
    - `std::memory_notification`åˆ—æŒ™ä½“ã‚’è¿½åŠ ã—ã¦ã€ãã‚Œã‚’å¼•æ•°ã«å–ã‚‹ã‚ˆã†ã«ã™ã‚‹

1ã¤ç›®ã®æ–¹æ³•ã§ã¯ã€æœ€åˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™

```cpp
#include <atomic>
#include <thread>

int main() {
  {
    // åŒæœŸç”¨ã‚¢ãƒˆãƒŸãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    std::atomic<bool> sync = false;

    std::thread{[&sync]{
      // ç ´æ£„ã•ã‚Œã‚‹å‰ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
      auto* pa = &sync;
      // å€¤ã‚’trueã«æ›´æ–°
      sync.store(true);
      // é€šçŸ¥
      std::atomic_notify_one(pa);
    }}.detach();

    // å€¤ãŒæ›´æ–°ï¼ˆtrueã«ãªã‚‹ï¼‰ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    sync.wait(false);
  }
```

ã“ã®æ™‚ã€ãƒã‚¤ãƒ³ã‚¿`pa`ã‚’`pa`ã®å‚ç…§å…ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç ´æ£„ã•ã‚ŒãŸå¾Œã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã‹ã«ã¯è­°è«–ãŒã‚ã‚Šã€Pointer lifetime-end zapã¨ã„ã†å•é¡Œã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ï¼ˆè©³ç´°ã¯ä»¥å‰ã®è¨˜äº‹å‚ç…§ï¼‰

- [P1726R4 : Pointer lifetime-end zap - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2020å¹´07æœˆï¼‰](https://onihusube.hatenablog.com/entry/2020/08/12/014639#P1726R4--Pointer-lifetime-end-zap)
- [P2414R0 Pointer lifetime-end zap proposed solutions - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´07æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/08/14/213339#P2414R0-Pointer-lifetime-end-zap-proposed-solutions)

ã—ãŸãŒã£ã¦ã€ã“ã®è§£æ±ºç­–ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã‚³ã‚¢è¨€èªã«ã“ã‚Œã‚‰ã®ææ¡ˆã«ã‚ˆã‚‹è§£æ±ºãŒå°å…¥ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

2ã¤ç›®ã®æ–¹æ³•ã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªåˆ—æŒ™ä½“ã¨ãã®å®šæ•°ã‚’æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿½åŠ ã—ã€`.store()`ãªã©ã®å€¤ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°ã«ã“ã‚Œã‚’å—ã‘å–ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```cpp
namespace std {
  enum class memory_notification : unspecified {
    notify_none = unspecified,
    notify_one = unspecified,
    notify_all = unspecified
  };
  inline constexpr auto memory_notify_none = memory_notification::notify_none;
  inline constexpr auto memory_notify_one = memory_notification::notify_one;
  inline constexpr auto memory_notify_all = memory_notification::notify_all;
}
```

ã“ã®æ–¹æ³•ã§ã¯ã€æœ€åˆã®ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™

```cpp
#include <atomic>
#include <thread>

int main() {
  {
    // åŒæœŸç”¨ã‚¢ãƒˆãƒŸãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    std::atomic<bool> sync = false;

    std::thread{[&sync]{
      // å€¤ã‚’trueã«æ›´æ–°ã—ã¦é€šçŸ¥
      sync.store(true, std::memory_notify_one);
    }}.detach();

    // å€¤ãŒæ›´æ–°ï¼ˆtrueã«ãªã‚‹ï¼‰ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    sync.wait(false);
  }
}
```

å®Ÿéš›ã®å®Ÿè£…ã§ã¯`std::atomic`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–ã£ã¦ã‹ã‚‰ã‚¹ãƒˆã‚¢æ“ä½œã¨é€šçŸ¥æ“ä½œã‚’è¡Œã†ï¼ˆ1ã®ã‚ˆã†ãªæ–¹æ³•ï¼‰ãŒå–ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œã¯å®Ÿè£…å®šç¾©ã®æŒ¯ã‚‹èˆã„ã¨ã—ã¦ï¼ˆç¾åœ¨ã®`std::counting_semaphore`ã®å®Ÿè£…ã®ã‚ˆã†ã«ï¼‰å‹•ä½œãŒä¿è¨¼ã•ã‚Œã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã§åŒã˜ã“ã¨ã‚’ã—ãŸå ´åˆã®æœªå®šç¾©å‹•ä½œã‚’å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- [P2616 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1279)

### [P2617R0 Responses to NB comments on DTS 12907 "Extensions to C++ for Transactional Memory Version 2"](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2617r0.html)

[Transactional Memory TS2](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/n4906.pdf)ã«å¯„ã›ã‚‰ã‚ŒãŸNBã‚³ãƒ¡ãƒ³ãƒˆã‚’å—ã‘ã¦ã®ä¿®æ­£ã‚’åæ˜ ã™ã‚‹ææ¡ˆã€‚

6ã¤ã®NBï¼ˆ*national body*ï¼‰ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆWG21ã®å„å›½æ¯ã®ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¿ãŸã„ãªã‚‚ã®ï¼‰ãŒå¯„ã›ã‚‰ã‚Œã€ãã®æŒ‡æ‘˜ã«å¯¾å‡¦ã™ã‚‹ãŸã‚ã®æ–‡è¨€å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã©ã†ã‚„ã‚‰å…¨ã¦ã‚«ãƒŠãƒ€ã®å§”å“¡ä¼šãƒ¡ãƒ³ãƒã‹ã‚‰ã®ã‚‚ã®ã§ã™ã€‚

ã“ã®ææ¡ˆã¯æ—¢ã«2022å¹´7æœˆã®å…¨ä½“ä¼šè­°ã§æ‰¿èªã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚

- [N4906 Transactional Memory TS2](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/n4906.pdf)
- [P2617 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1280)

### [P2618R0 C++ Standard Library Issues to be moved in Virtual Plenary, Jul. 2022](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2618r0.html)

ä»Šå›ï¼ˆ2022/07ï¼‰ã®ä¼šè­°ã§æ¡æŠã•ã‚ŒãŸæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã®Issueå ±å‘Šã¨ãã®è§£æ±ºã€‚

1. [3564. `transform_view::iterator<true>::value_type` and `iterator_category` should use `const F&`](https://wg21.cmeerw.net/lwg/issue3564)
2. [3617. `function/packaged_task` deduction guides and deducing this](https://wg21.cmeerw.net/lwg/issue3617)
3. [3656. Inconsistent bit operations returning a count](https://wg21.cmeerw.net/lwg/issue3656)
4. [3659. Consider ATOMIC_FLAG_INIT undeprecation](https://wg21.cmeerw.net/lwg/issue3659)
5. [3670. Cpp17InputIterators don't have integer-class difference types](https://wg21.cmeerw.net/lwg/issue3670)
6. [3671. `atomic_fetch_xor` missing from stdatomic.h](https://wg21.cmeerw.net/lwg/issue3671)
7. [3672. `common_iterator::operator->()` should return by value](https://wg21.cmeerw.net/lwg/issue3672)
8. [3683. `operator==` for `polymorphic_allocator` cannot deduce template argument in common cases](https://wg21.cmeerw.net/lwg/issue3683)
9. [3687. `expected<cv void, E>` move constructor should move](https://wg21.cmeerw.net/lwg/issue3687)
10. [3692. `zip_view::iterator`'s `operator<=>` is overconstrained](https://wg21.cmeerw.net/lwg/issue3692)
11. [3701. Make `formatter<remove_cvref_t<const charT[N]>, charT>` requirement explicit](https://wg21.cmeerw.net/lwg/issue3701)
12. [3702. Should `zip_transform_view::iterator` remove `operator<`?](https://wg21.cmeerw.net/lwg/issue3702)
13. [3703. Missing requirements for `expected<T, E>` requires `is_void<T>`](https://wg21.cmeerw.net/lwg/issue3703)
14. [3704. LWG 2059 added overloads that might be ill-formed for sets](https://wg21.cmeerw.net/lwg/issue3704)
15. [3705. Hashability shouldn't depend on `basic_string`'s allocator](https://wg21.cmeerw.net/lwg/issue3705)
16. [3707. `chunk_view::outer-iterator::value_type::size` should return unsigned type](https://wg21.cmeerw.net/lwg/issue3707)
17. [3708. `take_while_view::sentinel`'s conversion constructor should move](https://wg21.cmeerw.net/lwg/issue3708)
18. [3709. LWG-3703 was underly ambitious](https://wg21.cmeerw.net/lwg/issue3709)
19. [3710. The end of `chunk_view` for input ranges can be `const`](https://wg21.cmeerw.net/lwg/issue3710)
20. [3711. Missing preconditions for `slide_view` constructor](https://wg21.cmeerw.net/lwg/issue3711)
21. [3712. `chunk_view` and `slide_view` should not be `default_initializable`](https://wg21.cmeerw.net/lwg/issue3712)
22. [3713. Sorted with respect to comparator (only)](https://wg21.cmeerw.net/lwg/issue3713)
23. [3715. `view_interface::empty` is overconstrained](https://wg21.cmeerw.net/lwg/issue3715)
24. [3719. Directory iterators should be usable with default sentinel](https://wg21.cmeerw.net/lwg/issue3719)
25. [3721. Allow an arg-id with a value of zero for width in std-format-spec](https://wg21.cmeerw.net/lwg/issue3721)
26. [3724. decay-copy should be constrained](https://wg21.cmeerw.net/lwg/issue3724)

### [P2620R0 Lifting artificial restriction on universal character names](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2620r0.pdf)

ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰æ–‡å­—åã«ã‚ˆã£ã¦æŒ‡å®šã™ã‚‹ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿åï¼ˆåå‰ä»˜æ–‡å­—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰ã‚’è­˜åˆ¥å­ã«ä½¿ç”¨ã—ãŸæ™‚ã®åˆ¶é™ã‚’è§£é™¤ã™ã‚‹ææ¡ˆã€‚

åå‰ä»˜æ–‡å­—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆ*Named character escape*ï¼‰ã¯C++23ã§å°å…¥ã•ã‚ŒãŸã‚‚ã®ã§ã€`U'\N{LATIN CAPITAL LETTER A WITH MACRON}'`ã®ã‚ˆã†ã«ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿åã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã§ã™ã€‚è©³ç´°ã¯ä»¥å‰ã®è¨˜äº‹ã‚’å‚ç…§

- [P2071R1 Named universal character escapes - WG21æœˆæ¬¡ææ¡ˆæ–‡æ›¸ã‚’çœºã‚ã‚‹ï¼ˆ2021å¹´11æœˆï¼‰](https://onihusube.hatenablog.com/entry/2021/12/11/220126#P2071R1-Named-universal-character-escapes)

ã“ã®ææ¡ˆã®æŒ‡æ‘˜ã—ã¦ã„ã‚‹å•é¡Œã¨ã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã§ã™

```cpp
int main() {
  auto \N{LATIN CAPITAL LETTER I} = 42; // ngã€Iã¯ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿åã§æŒ‡å®šã§ããªã„
  auto \N{LATIN CAPITAL LETTER I WITH DOT ABOVE} = 42 ; // ok
}
```

`LATIN CAPITAL LETTER I`ã¨ã¯`I`ï¼ˆ`U+0049`ï¼‰ã®æ–‡å­—ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®Iï¼‰ã§ã‚ã‚Šã€ã“ã‚Œã¯åŸºæœ¬æ–‡å­—é›†åˆã«å«ã¾ã‚Œã‚‹æ–‡å­—ã§ã‚ã‚‹ãŸã‚ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿åã«ã‚ˆã£ã¦æŒ‡å®šã§ãã¾ã›ã‚“ã€‚`LATIN CAPITAL LETTER I WITH DOT ABOVE`ã¯Iã®ä¸Šã«ãƒ‰ãƒƒãƒˆãŒã¤ã„ã¦ã„ã‚‹æ–‡å­—`Ä°`ï¼ˆ`U+0130`ï¼‰ã§ã€ã“ã‚Œã¯åŸºæœ¬æ–‡å­—é›†åˆã«å«ã¾ã‚Œç„¡ã„ãŸã‚ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿åã«ã‚ˆã£ã¦æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã“ã¨ã¯ã€æ–‡å­—/æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«å†…ã§ã¯åŒºåˆ¥ã•ã‚Œãªã„ãŸã‚å•é¡Œã«ãªã‚Šã¾ã›ã‚“ãŒã€è­˜åˆ¥å­ã§ä½¿ç”¨ã•ã‚ŒãŸæ™‚ã ã‘ã“ã®ã‚ˆã†ãªé•ã„ãŒç”Ÿã˜ã¾ã™ã€‚ã“ã®ææ¡ˆã¯ã€ã“ã®åˆ¶é™ã‚’å–ã‚Šæ‰•ãŠã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

- [P2620 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1282)

### [P2621R0 UB? In my Lexer?](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2621r0.pdf)

å­—å¥è§£æã™ã‚‹ã ã‘ã§æœªå®šç¾©å‹•ä½œã‚’å¼•ãèµ·ã“ã™ã‚‚ã®ã«ã¤ã„ã¦ã€æœªå®šç¾©ã§ã¯ãªãã™ã‚‹ææ¡ˆã€‚

ã“ã®ææ¡ˆã«ã‚ˆã‚Œã°ã€æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¯è¦æ ¼çš„ã«ã¯æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ã‚ˆã†ã§ã™

```cpp
int \\ // UB : è¤‡æ•°è¡Œã«ã‚ãŸã‚‹ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«æ–‡å­—å
u\
0\
3\
9\
1 = 0;

#define CONCAT(x, y) x ## y
int CONCAT(\, u0393) = 0; // UB: ãƒã‚¯ãƒ­å±•é–‹ã«ã‚ˆã£ã¦å½¢æˆã•ã‚Œã‚‹ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«æ–‡å­—å

// UB: é–‰ã˜ã¦ã„ãªã„æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«
const char * foo = "
```

ã“ã®ææ¡ˆã¯ã€ã“ã‚Œã‚‰ã®æœªå®šç¾©å‹•ä½œã‚’å®Ÿéš›ã®å®Ÿè£…ã«åˆã‚ã›ã‚‹å½¢ã§æŒ¯ã‚‹èˆã„ã‚’å®šç¾©ã—ã‚ˆã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

|UB|GCC|clang|EDG|MSVC|
|---|---|---|---|---|
|è¤‡æ•°è¡ŒUCN|Supported|Supported|Error|Supported|
|`##`ã«ã‚ˆã‚‹UCNã®å½¢æˆ|Supported|Supported|Supported|Supported|
|é–‰ã˜ã¦ã„ãªã„æ–‡å­—ï¼ˆåˆ—ï¼‰ãƒªãƒ†ãƒ©ãƒ«|ill-formed|ill-formed|ill-formed|ill-formed|

ã“ã‚Œã‚‰ã®ã“ã¨ã‚’è¸ã¾ãˆã¦ã€ã“ã®ææ¡ˆã¯3ã¤ã®UBã‚’æ¬¡ã®ã‚ˆã†ã«ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™

|UB|ææ¡ˆ|
|---|---|
|è¤‡æ•°è¡ŒUCN|Well-formed|
|`##`ã«ã‚ˆã‚‹UCNã®å½¢æˆ|Well-formed|
|é–‰ã˜ã¦ã„ãªã„æ–‡å­—ï¼ˆåˆ—ï¼‰ãƒªãƒ†ãƒ©ãƒ«|ill-formed|

å¾“ã£ã¦ã€MSVCã®è¤‡æ•°è¡ŒUCNå®Ÿè£…ã ã‘ãŒã“ã®ææ¡ˆã®å½±éŸ¿ã‚’å—ã‘ã¾ã™ã€‚ã—ã‹ã—ã€ç¾åœ¨ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã„ã‚‹ã®ã§ãã®å½±éŸ¿ã¯ç ´å£Šçš„ãªã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

- [P2621 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1283)

### [P2622R0 Core Language Working Group "ready" Issues for the July, 2022 meeting](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2622r0.html)

ä»Šå›ï¼ˆ2022/07ï¼‰ã®ä¼šè­°ã§æ¡æŠã•ã‚ŒãŸã‚³ã‚¢è¨€èªã«ã¤ã„ã¦ã®Issueå ±å‘Šã¨ãã®è§£æ±ºã€‚

1. [2355. Deducing noexcept-specifiers](https://wg21.cmeerw.net/cwg/issue2355)
2. [2405. Additional type-dependent expressions](https://wg21.cmeerw.net/cwg/issue2405)
3. [2507. Default arguments for operator[]](https://wg21.cmeerw.net/cwg/issue2507)
4. [2534. Value category of pseudo-destructor expression](https://wg21.cmeerw.net/cwg/issue2534)
5. [2535. Type punning in class member access](https://wg21.cmeerw.net/cwg/issue2535)
6. [2540. Unspecified interpretation of numeric-escape-sequence](https://wg21.cmeerw.net/cwg/issue2540)
7. [2571. Evaluation order for subscripting](https://wg21.cmeerw.net/cwg/issue2571)
8. [2582. Differing member lookup from nested classes](https://wg21.cmeerw.net/cwg/issue2582)
9. [2585. Name lookup for coroutine allocation](https://wg21.cmeerw.net/cwg/issue2585)
10. [2586. Explicit object parameter for assignment and comparison](https://wg21.cmeerw.net/cwg/issue2586)
11. [2594. Disallowing a global function template main](https://wg21.cmeerw.net/cwg/issue2594)
12. [2597. Replaceable allocation and deallocation functions in the global module](https://wg21.cmeerw.net/cwg/issue2597)
13. [2606. static_cast from "pointer to void" does not handle similar types](https://wg21.cmeerw.net/cwg/issue2606)
14. [2608. Omitting an empty template argument list](https://wg21.cmeerw.net/cwg/issue2608)

### [P2623R0 implicit constant initialization](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2623r0.html)

ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å‚ç…§ã«ã‚ˆã‚‹ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ç™ºç”Ÿã‚’å‰Šæ¸›ã™ã‚‹ææ¡ˆã€‚

ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å‚ç…§ã«ã‚ˆã£ã¦ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ãŒç™ºç”Ÿã™ã‚‹ã®ã¯ä¸»ã«æ¬¡ã®2ã¤ã®å ´åˆã§ã™

1. é–¢æ•°ã‹ã‚‰è¿”ã•ã‚ŒãŸå‚ç…§
2. é–¢æ•°ã‹ã‚‰è¿”ã•ã‚ŒãŸã€å€¤ã®ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’æŒãŸãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ`std::string_view`ãªã©ï¼‰

ä¾‹ãˆã°2ã¤ç›®ã®å ´åˆã ã¨ã€æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ç°¡å˜ã«ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã‚’ç”Ÿæˆã§ãã¾ã™

```cpp
using namespace std::string_literals;

int main () {
  std::string_view sv = "hello world"s; // ã“ã®è¡Œä»¥é™svã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã¨ãªã‚‹ã€ãã®ä½¿ç”¨ã¯UB
}
```

`"hello world"s`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒªãƒ†ãƒ©ãƒ«`s`ã«ã‚ˆã£ã¦`std::string`ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚ãã‚Œã‚’`std::string_view`ã§ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã¨ã€ã™ãã«ãã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¯¿å‘½ãŒå°½ãã¦ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã¨ãªã‚Šã¾ã™ã€‚

ã“ã®ææ¡ˆã®ç›®çš„ã¯ã€ã“ã®ã‚³ãƒ¼ãƒ‰ãŒUBï¼ˆãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ï¼‰ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€å®šæ•°å¼`"hello world"s`ãŒé€šå¸¸ã®æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¨åŒæ§˜ã«é™çš„è¨˜æ†¶åŸŸæœŸé–“ï¼ˆ*static storage duration*ï¼‰ã‚’æŒã¤ã‚ˆã†ã«ã™ã‚‹ï¼ˆæš—é»™çš„ãªå®šæ•°åˆæœŸåŒ–ã‚’è¡Œã†ï¼‰ã“ã¨ã§ã€ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã®ç”Ÿæˆã‚’é˜²æ­¢ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€`std::string_view`ã«ã‚ˆã‚‹ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã¯æ¬¡ã®ã‚ˆã†ã«é–“æ¥çš„ã«ç™ºç”Ÿã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™

```cpp
std::string operator+(std::string_view s1, std::string_view s2) {
  return std::string{s1} + std::string{s2};
}

auto f() {
  std::string_view sv = "hi";
  sv = sv + sv; // svã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°
  ...
}
```

`sv + sv`ã®çµæœã¯`std::string`ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚Šã€ãã®å¯¿å‘½ã¯ãã®å¼ã®çµ‚ã‚ã‚Šï¼ˆ`;`ï¼‰ã¾ã§ã§ã™ã€‚

ã“ã®ææ¡ˆã§ã¯ã€ã“ã®å ´åˆã«ã“ã®å¼ã®çµæœç”Ÿæˆã•ã‚Œã‚‹ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ã‚’ãã®å¼ã§ã¯ãªãå›²ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¨ãƒã‚¤ãƒ³ãƒ‰ã•ã›ã‚‹ã“ã¨ã§ã€ã“ã®ã‚ˆã†ãªãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã‚’é˜²æ­¢ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€ã“ã®å ´åˆã§ã‚‚ã“ã®å‚ç…§ï¼ˆ`sv`ï¼‰ã‚’ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®å¤–ã«æŒã¡å‡ºã—ã¦ã—ã¾ãˆã°ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã¨ãªã‚Šã¾ã™ãŒãã‚Œã¯ç¾åœ¨ã§ã‚‚åŒã˜ã“ã¨ã§ã€ã“ã®ææ¡ˆã®ç›®çš„ã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã®ç™ºç”Ÿã‚’æŠ‘åˆ¶ã™ã‚‹ã“ã¨ã«ã‚ã‚Šã€å®Œå…¨ã«å¤±ãã™ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã¯ã„ã¾ã›ã‚“ã€‚

1ã¤ç›®ã®å ´åˆï¼ˆé–¢æ•°ã®å‚ç…§æˆ»ã‚Šå€¤ï¼‰ã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªå ´åˆã«ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã‚’ç”Ÿæˆã§ãã¾ã™

```cpp
struct X { int a, b; };

const int& f(const X& x) { return x.a; }  // å¼•æ•°ã®ãƒ¡ãƒ³ãƒã¸ã®å‚ç…§ã‚’è¿”ã™

int main() {
  const int& a = f({4, 2}); // ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•æ•°ã§ä¸ãˆã‚‹
                            // aã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã€UB
}
```

ã“ã®æ™‚ã§ã‚‚ã€`{4, 2}`ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ãŒå›²ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«ç´ã¥ã„ã¦ã„ã‚Œã°ã€ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã¯ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã€‚

`std::string`ã§ã¯ã€ã“ã®ä¾‹ã¨ã‚ˆãä¼¼ãŸã“ã¨ã‚’ç°¡å˜ã«èµ·ã“ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```cpp
char& c = std::string{"hello my pretty long string"}[0];
c = 'x'; // cã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã€UB
std::cout << "c: " << c << '\n'; // cã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã€UB
```

ã“ã®æ™‚ã§ã‚‚ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ãŒãã®å¼ã§ã¯ãªãå›²ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã«ç´ã¥ã„ã¦ã„ã‚Œã°ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã‚’å›é¿ã§ãã¾ã™ã€‚ã“ã“ã§ã€ã“ã®ã‚ˆã†ãªä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¯¿å‘½ã«ã¾ã¤ã‚ã‚‹å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ•°ã«å—ã‘ã¦ã¿ã‚‹ã¨ç¾åœ¨ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ã®ãƒ«ãƒ¼ãƒ«ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒã®æœŸå¾…ã¨ä¸€è‡´ã—ã¦ã„ãªã„ã“ã¨ãŒå£é–“è¦‹ãˆã¾ã™ã€‚

```cpp
auto anonymous = std::string{"hello my pretty long string"};
char& c = anonymous[0];
c = 'x'; // okã€cã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã§ã¯ãªã„
std::cout << "c: " << c << '\n'; // okã€cã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã§ã¯ãªã„
```

ã“ã‚Œã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒã‹ã‚‰è¦‹ã‚Œã°ã»ã¼åŒã˜ã‚³ãƒ¼ãƒ‰ã§ã™ãŒã€ã“ã®ã‚ˆã†ã«ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åå‰ã¥ã‘ã‚’ã™ã‚‹ã ã‘ã§ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã®ç”Ÿæˆã‚’å›é¿ã§ãã¾ã™ã€‚ã—ã‹ã—ã“ã‚Œã¯ã€ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ã‚’å›²ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã«ç´ã¥ã‘ã‚‹ã¨ã„ã†æ“ä½œã‚’æ‰‹å‹•ã§ã‚„ã£ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

ã“ã®ã‚ˆã†ãªã“ã¨ãŒæ„å›³ã›ãšç™ºç”Ÿã—ã†ã‚‹ã‚‚ã®ã¨ã—ã¦ç¯„å›²`for`ãŒã‚ˆãçŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

```cpp
for (auto x : reversed(make_vector())) { ... }
```

`make_vector()`ãŒ`std::vector`ã®å³è¾ºå€¤ã‚’è¿”ã—ã€`reversed()`ãŒ[`std::ranges::owning_view`](https://cpprefjp.github.io/reference/ranges/owning_view.html)ã®ã‚ˆã†ãªä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“å»¶é•·ã®ãŸã‚ã®ã‚±ã‚¢ã‚’ã—ãªã„å ´åˆã€ã“ã®ç¯„å›²`for`å…¨ä½“ã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã—ãŸç¯„å›²ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ç¯„å›²`for`ã¯æ¬¡ã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œã¦ã„ã¾ã™

```cpp
{// containing block
  auto&& rg = reversed(make_vector());  // ã“ã®è¡Œã§make_vector()ã®æˆ»ã‚Šå€¤ã®å¯¿å‘½ãŒå°½ãã‚‹
  auto pos = rg.begin();
  auto end = rg.end();
  for ( ; pos != end; ++pos ) {
    auto x = *pos;
    ...
  }
}
```

ã“ã®æ™‚ã§ã‚‚ã€ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ãŒå›²ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã«ç´ã¥ã„ã¦ã„ã‚Œã°ã€ã“ã®ã‚ˆã†ãªUBã‚’å›é¿ã§ãã¾ã™ã€‚ãã®ã“ã¨ã¯ã€ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ˜ç¤ºçš„ã«åå‰ã‚’ä¸ãˆã¦ã¿ã‚‹ã¨ã‚ã‹ã‚Šã¾ã™

```cpp
{// containing block
  auto anonymous1 = make_vector();
  auto anonymous2 = reversed(anonymous1);
  auto pos = anonymous2.begin();
  auto end = anonymous2.end();
  for ( ; pos != end; ++pos ) {
    auto x = *pos;
    ...
  }
}
```

ã“ã®ææ¡ˆã®ä¸»å¼µã™ã‚‹ã“ã¨ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒã‹ã‚‰è¦‹ã‚Œã°ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã¯åå‰ã®ãªã„å¤‰æ•°ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãã®è¦³ç‚¹ã‹ã‚‰ã€ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¯¿å‘½ã‚’é€šå¸¸ã®å¤‰æ•°ã®ã‚ˆã†ã«ã™ã‚Œã°ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã®ç™ºç”Ÿã‚’æ¸›ã‚‰ã™ã ã‘ã§ãªãã€ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹é–¢æ•°æˆ»ã‚Šå€¤ã‚’å—ã‘ã‚‹ãŸã‚ã®ä½™è¨ˆãªå¤‰æ•°ã®åå‰ã¥ã‘ã‚’å‰Šæ¸›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ³¨æ„ã—ã¦é–¢æ•°æˆ»ã‚Šå€¤ã‚’å‘½åã™ã‚‹ã®ã§ã¯ãªãã€ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¥¨åŠ±ã™ã‚‹ã“ã¨ã™ã‚‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã‚ˆã‚Šè©³ç´°ã«ã¯ã€ã“ã®ææ¡ˆã§ã¯ã“ã‚Œã‚‰ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã†ã¡ã€æš—é»™çš„ãªå®šæ•°åˆæœŸåŒ–ãŒå¯èƒ½ãªå ´åˆï¼ˆ`constexpr`ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’æŒã¤å‹ã®`const`å‚ç…§ï¼‰ã«ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«å®šæ•°åˆæœŸåŒ–ã—ã¦é™çš„è¨˜æ†¶åŸŸæœŸé–“ã‚’ä¸ãˆã‚‹ã“ã¨ã§ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãã—ã€ãã®ã‚ˆã†ãªå®šæ•°åˆæœŸåŒ–ãŒã§ããªã„ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦ã¯ãã®å¯¿å‘½ã‚’å›²ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã‚¹ã‚³ãƒ¼ãƒ—ã«ã¾ã§å»¶é•·ï¼ˆé€šå¸¸ã®åå‰ä»˜ãå¤‰æ•°ã¨åŒæ§˜ã«ï¼‰ã™ã‚‹ã“ã¨ã§ã€ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã®ç™ºç”Ÿã‚’é˜²æ­¢ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

```cpp
// std::mapã‹ã‚‰ã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹å€¤ã‚’å–å¾—ã™ã‚‹ã€ãªã‘ã‚Œã°æŒ‡å®šã—ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¿”ã™
const V& findOrDefault(const std::map<K,V>& m, const K& key, const V& defvalue);

void f() {
  std::map<std::string, std::string> myMap;
  const std::string& s = findOrDefault(myMap, key, "none"); // "none"ã¯std::stringã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  // ç¾åœ¨ã¯sã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§
  // ã“ã®ææ¡ˆå¾Œã¯å®šæ•°åˆæœŸåŒ–ã•ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«ãª"none"ï¼ˆstd::stringã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’æŒ‡ã™
}

std::string make_str(); // éconstexpré–¢æ•°

void g() {
  std::map<std::string, std::string> myMap;
  const std::string& s = findOrDefault(myMap, key, make_str());  // å®Ÿè¡Œæ™‚æ–‡å­—åˆ—ã§ä½¿ç”¨ã—ãŸå ´åˆ
  // ç¾åœ¨ã¯sã¯ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§
  // ã“ã®ææ¡ˆå¾Œã¯make_str()ã®æˆ»ã‚Šå€¤ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¯¿å‘½ã¯å›²ã‚€ã‚¹ã‚³ãƒ¼ãƒ—ã«æ‹¡å¼µã•ã‚Œã‚‹ãŸã‚ã€ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ã§ã¯ãªããªã‚‹
}
```

ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ã‚’å›²ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã«æ‹¡å¼µã™ã‚‹ã®ã¯ã€ç¾åœ¨ã®C++ã§ã‚‚åˆ¶é™çš„ãªãŒã‚‰èµ·ã“ã£ã¦ãŠã‚Šã€ã“ã®ã“ã¨ã¯å…¨ãæ–°ã—ã„ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```cpp
template<typename T> using id = T;

int i = 1;
int&& a = id<int[3]>{1, 2, 3}[i]; // é…åˆ—ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¯¿å‘½ã¯aã®å¯¿å‘½ã¨åŒæœŸã™ã‚‹
const int& b = static_cast<const int&>(0); // intã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¯¿å‘½ã¯bã®å¯¿å‘½ã¨åŒæœŸã™ã‚‹
int&& c = cond ? id<int[3]>{1, 2, 3}[i] : static_cast<int&&>(0);  // æ¡ä»¶æ¼”ç®—å­ã®ä¸¡æ–¹ã®ã‚ªãƒšãƒ©ãƒ³ãƒ‰ã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¯¿å‘½ã¯cã®å¯¿å‘½ã¨åŒæœŸã™ã‚‹
```

ã“ã®ææ¡ˆã®å†…å®¹ã¯ä»¥å‰ã®[P0936R0](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0936r0.pdf)ã‚’å¼•ãç¶™ãã‚‚ã®ã§ã™ã€‚ãã¡ã‚‰ã§ã¯è¿½åŠ ã®æ³¨é‡ˆã«ã‚ˆã£ã¦å¼•æ•°ã‚„æˆ»ã‚Šå€¤ã®ç”Ÿå­˜æœŸé–“ã®å»¶é•·ï¼ˆã“ã®ææ¡ˆã®ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è‡ªå‹•å¤‰æ•°åŒ–ï¼‰ã‚’è¡Œãªã£ã¦ã„ã¾ã—ãŸãŒã€ã“ã®ææ¡ˆã§ã¯ãã‚Œã¨åŒã˜ã“ã¨ã‚’æš—é»™çš„ã«è¡Œã„ã¾ã™ã€‚ã“ã®ææ¡ˆã¯ãã“ã«ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æš—é»™çš„å®šæ•°åˆæœŸåŒ–ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§P0936ã‚’è£œå¼·ã™ã‚‹ã¨ã¨ã‚‚ã«ã€P0936ã®å†…å®¹ã ã‘ã§ã¯é©åˆ‡ãªå¯¾ç­–ã¨ãªã‚‰ãªã„ã‚‚ã®ã«ã¤ã„ã¦ã‚ˆã‚Šå®‰å…¨ã«ã—ã‚ˆã†ã¨ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

- [P0936R0 Bind Returned/Initialized Objects to the Lifetime of Parameters, Rev0](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0936r0.pdf)
- [P2623 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1285)

### [P2624R0 Make operations on bools more portable](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2624r0.html)

`bool`å‹ã«é–¢ã™ã‚‹æ¨™æº–ã®çŸ›ç›¾ã‚’æ­£ã™ææ¡ˆã€‚

æ¨™æº–ã§ã¯ã€`bool`å‹ã«ã¤ã„ã¦æ¬¡ã®ã‚ˆã†ã«æŒ‡å®šã—ã¦ã„ã¾ã™

- å®Ÿè£…å®šç¾©ã®ç¬¦å·ãªã—æ•´æ•°å‹ã¨åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¾ã€å€¤è¡¨ç¾ã€ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã‚’æŒã¤
- `bool`å‹ã®å€¤ã¯`true`ã¨`false`

å‹`T`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¾ã¨ã¯`T`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`unsigned char[N]`ã§å‚ç…§ã—ãŸæ™‚ã®ãƒã‚¤ãƒˆåˆ—ã®ã“ã¨ã§ã€`T`ã®å€¤è¡¨ç¾ã¨ã¯`T`ã®å€¤ã‚’ä¿æŒã™ã‚‹ãƒ“ãƒƒãƒˆåˆ—ã®ã“ã¨ã§ã™ã€‚

`bool`ã®å€¤ã¯2ã¤ã—ã‹å–ã‚Œãªã„ã¨ã™ã‚‹å ´åˆã€å°‘ãªãã¨ã‚‚256ã®ç•°ãªã‚‹å€¤ã‚’å–ã‚Œã‚‹ç¬¦å·ãªã—æ•´æ•°å‹ã¨åŒã˜å€¤è¡¨ç¾ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã“ã®çŸ›ç›¾ã«ã‚ˆã£ã¦ã€`bool`å‹ã®ã©ã®ã‚ˆã†ãªå®Ÿè£…ã‚‚æ¨™æº–ã«é©åˆã™ã‚‹ã“ã¨ã¯ã§ãã¦ãŠã‚‰ãšã€ã•ã¾ã–ã¾ãªæ–¹æ³•ã§æ¨™æº–ã®è¦å®šã‚’è¿‘ä¼¼ã—ã¦ã„ã¾ã™ã€‚

- clang : 1ãƒã‚¤ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸­ã®1ãƒ“ãƒƒãƒˆã®ãƒ“ãƒƒãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚ã‚‹ã‹ã®ã‚ˆã†ã«å®Ÿè£…
    - ä¸‹ä½1ãƒ“ãƒƒãƒˆã®ã¿ãŒå€¤ã«é–¢ä¸ã—ã€æ®‹ã‚Šã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãƒ“ãƒƒãƒˆ
    - 2ã¤ã®å€¤ã®ã¿ã‚’å–ã‚Œã‚‹ã¨ã„ã†è¦å®šã‚’æº€ãŸã™ã‚‚ã®ã®ã€ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ç¬¦å·ãªã—æ•´æ•°å‹ã¨åŒã˜å€¤è¡¨ç¾ã‚’æŒãŸãªã„
- GCC/MSVC : `enum bool : unsigned char { false, true };`ã®ã‚ˆã†ãªå‹ã¨ã—ã¦å®Ÿè£…
    - ç¬¦å·ãªã—æ•´æ•°å‹ã¨åŒã˜å€¤è¡¨ç¾ã‚’æŒã¤ã‚‚ã®ã®ã€ç•°ãªã‚‹256ã®å€¤ã‚’æŒã¤ã“ã¨ãŒã§ãã‚‹

ã“ã®é•ã„ã«ã‚ˆã£ã¦ã€å¾®å¦™ãªæŒ¯ã‚‹èˆã„ã®é•ã„ã‚’è¦³æ¸¬ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```cpp
// clangã¯å¸¸ã« 0 or 1ã®ã©ã¡ã‚‰ã‹ã‚’è¿”ã™
// msvc & gccã¯ 0, 1, -1ã®ã©ã‚Œã‹ã‚’è¿”ã™
int test1(bool b) { 
  switch(b) {
    case false: return 0;
    case true: return 1;
    default: return -1;
  }
}
 
// clang & msvcã¯å¸¸ã« 1ã‚’è¿”ã™
// gccã¯ 1ã‹2ã®ã©ã¡ã‚‰ã‹ã‚’è¿”ã™
int test2(bool b) {
  int n = 0;

  if (b) n++;
  if (!b) n++;
  
  return n;
}
 
// clangã¯å¸¸ã« 0 or 2ã®ã©ã¡ã‚‰ã‹ã‚’è¿”ã™
// msvc & gccã¯ 0~510ã®é–“ã®ä»»æ„ã®å€¤ã‚’è¿”ã™
int test3(bool b) { return b + b; }
 
// clang & msvcã¯å¸¸ã« 0 or 1ã®ã©ã¡ã‚‰ã‹ã‚’è¿”ã™
// gccã¯ 0~255ã®é–“ã®ä»»æ„ã®å€¤ã‚’è¿”ã™
int test4(bool b) { return b || b; }
```

ã“ã®ææ¡ˆã®ç›®çš„ã¯ã€ã“ã‚Œã‚‰ã®ã“ã¨ã‚’æ­£ã™ã“ã¨ã§`bool`ã‚’å«ã‚€å¼ãŒæ•°å­¦çš„è«–ç†ã¨ä¸€è‡´ã—ãŸäºˆæ¸¬å¯èƒ½ã§æ„å¤–æ€§ã®ãªã„çµæœã‚’è¿”ã™ã‚ˆã†ã«ã—ã€`bool`å‹ã®å¤‰æ•°ã‚’å®‰å…¨ã‹ã¤ãƒãƒ¼ã‚¿ãƒ–ãƒ«ã«ä½¿ç”¨å¯èƒ½ã¨ã™ã‚‹ã“ã¨ã§ã™ã€‚

ã“ã®ææ¡ˆã®å†…å®¹ã«clangã¯æ—¢ã«æº–æ‹ ã—ã¦ã„ã¾ã™ãŒGCC/MSVCã¯ãã†ã§ã¯ãªãã€GCC/MSVCã®ç¾åœ¨ã®æŒ™å‹•ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¯å‹•ä½œãŒå¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

- [`std::has_unique_object_representations` - cpprefjp](https://cpprefjp.github.io/reference/type_traits/has_unique_object_representations.html)
- [P2624 é€²è¡ŒçŠ¶æ³](https://github.com/cplusplus/papers/issues/1286)
